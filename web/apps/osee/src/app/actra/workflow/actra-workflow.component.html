<!--
 * Copyright (c) 2025 Boeing
 *
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 *     Boeing - initial API and implementation
 -->

@if (workDef() && twAttributeTypes()) {
	<div
		class="tw-flex tw-flex-col tw-gap-2 tw-rounded-2xl tw-bg-gray-50 tw-p-6 tw-shadow-lg">
		<!-- Save Button Row -->
		<div class="tw-flex tw-justify-start">
			<button
				[disabled]="!hasChanges()"
				(click)="saveChanges()"
				mat-icon-button
				[matTooltip]="
					hasChanges() ? 'Save changes' : 'No changes to save'
				"
				class="tw-rounded-full tw-border tw-border-gray-300 tw-bg-white tw-p-2 hover:tw-shadow-md disabled:tw-opacity-50">
				<mat-icon
					[class]="
						hasChanges() ? 'tw-text-blue-600' : 'tw-text-gray-400'
					"
					>save</mat-icon
				>
			</button>
		</div>

		<!-- Workflow Details -->
		<osee-expansion-panel
			title="Team Workflow Details"
			[openDefault]="true">
			<div
				class="tw-grid tw-grid-cols-1 tw-gap-2 tw-p-6 md:tw-grid-cols-2 lg:tw-grid-cols-3">
				<div>
					<span class="tw-font-semibold tw-text-gray-700"
						>Title:</span
					>
					{{ wf.Name }}
				</div>
				<div>
					<span class="tw-font-semibold tw-text-gray-700"
						>Workflow ID:</span
					>
					{{ wf.AtsId }}
				</div>
				<div>
					<span class="tw-font-semibold tw-text-gray-700"
						>Action ID:</span
					>
					{{ wf.ActionAtsId }}
				</div>
				<div>
					<span class="tw-font-semibold tw-text-gray-700"
						>Created:</span
					>
					{{ wf.CreatedDate }}
				</div>
				<div>
					<span class="tw-font-semibold tw-text-gray-700"
						>Created By:</span
					>
					{{ wf.CreatedBy }}
				</div>
				<div>
					<span class="tw-font-semibold tw-text-gray-700">Team:</span>
					{{ wf.TeamName }}
				</div>
				<div>
					<span class="tw-font-semibold tw-text-gray-700"
						>State:</span
					>
					{{ wf.currentState.state }}
				</div>
				<div>
					<span class="tw-font-semibold tw-text-gray-700"
						>Assignees:</span
					>
					{{ assigneesString() }}
				</div>
				<div>
					<span class="tw-font-semibold tw-text-gray-700"
						>Version:</span
					>
					{{ wf.TargetedVersion }}
				</div>
			</div>
		</osee-expansion-panel>

		<!-- State Actions -->
		<div class="tw-flex tw-items-center tw-justify-between tw-gap-2">
			<div class="tw-flex tw-items-center tw-gap-2">
				<span class="tw-text-lg tw-font-bold">Current State:</span>
				<osee-action-dropdown
					[teamWorkflow]="wf"
					[commitAllowed]="false"
					(update)="updateWorkflow()" />
			</div>

			@if (wf.currentState.committable || wf.workingBranch.id !== '-1') {
				@if (wf.workingBranch.id === '-1') {
					<osee-create-action-working-branch-button
						[teamWorkflow]="wf" />
				} @else {
					<div class="tw-flex tw-items-center tw-gap-2">
						<button
							mat-raised-button
							[class]="
								allBranchesCommitted()
									? 'tw-bg-green-600'
									: 'tw-bg-blue-600'
							"
							class="tw-rounded-lg tw-px-4 tw-py-2 tw-font-semibold tw-text-white hover:tw-opacity-90"
							[matTooltip]="
								allBranchesCommitted()
									? 'All commits are complete'
									: 'There are ' +
										wf.branchesToCommitTo.length +
										' branches left to commit to'
							"
							(click)="openCommitManager()">
							Open Commit Manager
						</button>

						<osee-update-from-parent-button
							[workingBranch]="wf.workingBranch"
							(updated)="updateWorkflow()" />

						<div
							[matTooltip]="
								wf.branchEditable
									? 'Open branch in Artifact Explorer'
									: 'Branch is not editable'
							">
							<button
								mat-raised-button
								[disabled]="!wf.branchEditable"
								class="tw-flex tw-items-center tw-justify-center tw-rounded-lg tw-bg-primary tw-p-2 tw-text-white hover:tw-shadow"
								[class]="
									wf.branchEditable
										? 'tw-opacity-100'
										: 'tw-opacity-50'
								"
								(click)="openInArtifactExplorer()">
								<mat-icon>padding</mat-icon>
							</button>
						</div>
					</div>
				}
			}
		</div>

		<!-- Previous State Panels -->
		@for (state of previousStates(); track $index) {
			<osee-expansion-panel
				[title]="state.state"
				[openDefault]="wf.currentState.state === state.state"
				class="tw-mt-4 tw-rounded-xl tw-shadow-sm">
				<div class="tw-px-4 tw-pt-4">
					<osee-attributes-editor
						[attributes]="stateAttributes().get(state.state) || []"
						[editable]="true"
						(updatedAttributes)="handleUpdatedAttributes($event)" />
				</div>
			</osee-expansion-panel>
		}
	</div>
} @else {
	<div class="tw-p-8 tw-text-center tw-text-lg tw-text-gray-500">
		Loading workflow...
	</div>
}
