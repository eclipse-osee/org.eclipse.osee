<!--
* Copyright (c) 2021 Boeing
*
* This program and the accompanying materials are made
* available under the terms of the Eclipse Public License 2.0
* which is available at https://www.eclipse.org/legal/epl-2.0/
*
* SPDX-License-Identifier: EPL-2.0
*
* Contributors:
*     Boeing - initial API and implementation
-->
<div class="mat-elevation-z8">
	<mat-form-field class="tw-w-full">
		<mat-label>Filter Configuration Information</mat-label>
		<input
			matInput
			type="text"
			[(ngModel)]="filter"
			#input />
		<mat-icon matPrefix>filter_list</mat-icon>
		<mat-hint>Enter text to filter Configuration Table</mat-hint>
	</mat-form-field>
	<div
		class="tw-h-[72vh] tw-w-full tw-overflow-auto [&::-webkit-scrollbar-corner]:tw-bg-background-app-bar [&::-webkit-scrollbar-thumb]:tw-bg-primary [&::-webkit-scrollbar-track]:tw-border-r-[10px] [&::-webkit-scrollbar-track]:tw-bg-background-app-bar [&::-webkit-scrollbar]:tw-bg-background-app-bar">
		<table
			mat-table
			[dataSource]="dataSource"
			matSort
			matSortActive="feature"
			matSortDirection="asc"
			class="mat-elevation-z8 tw-w-full tw-border-separate">
			<ng-container matColumnDef=" ">
				<th
					mat-header-cell
					*matHeaderCellDef
					colspan="1"
					class="tw-border-b-2 tw-border-r-2 tw-border-solid tw-border-foreground-divider tw-text-center tw-text-sm tw-font-bold tw-tracking-tighter tw-text-primary-600"></th>
			</ng-container>
			<ng-container matColumnDef="Configurations">
				<th
					mat-header-cell
					*matHeaderCellDef
					[attr.colspan]="viewCount | async"
					class="tw-border-b-2 tw-border-r-2 tw-border-solid tw-border-foreground-divider tw-text-center tw-text-sm tw-font-bold tw-tracking-tighter tw-text-primary-600">
					Configurations
				</th>
			</ng-container>
			<ng-container matColumnDef="Groups">
				<th
					mat-header-cell
					*matHeaderCellDef
					[attr.colspan]="(groupCount | async) || 0"
					class="tw-border-b-2 tw-border-r-0 tw-border-solid tw-border-foreground-divider tw-text-center tw-text-sm tw-font-bold tw-tracking-tighter tw-text-primary-600">
					Configuration Groups
				</th>
			</ng-container>
			@for (
				secondaryHeader of secondaryHeaders | async;
				track valueTracker(i, secondaryHeader);
				let i = $index
			) {
				<ng-container [matColumnDef]="secondaryHeader">
					<th
						mat-header-cell
						*matHeaderCellDef
						[attr.colspan]="(secondaryHeaderLength | async)![i]"
						[ngClass]="
							(isACfgGroup(secondaryHeader.trim()) | async)
								? (isAddedCfgGroup(secondaryHeader.trim())
										| async) === true
									? 'tw-bg-success-300 tw-text-primary-darker'
									: (isDeletedCfgGroup(secondaryHeader.trim())
												| async) === true
									  ? 'tw-bg-warning-100 tw-text-primary-darker'
									  : (hasChangesCfgGroup(
													secondaryHeader.trim()
									      ) | async) === true
									    ? 'tw-bg-accent-100 tw-text-primary-darker'
									    : 'tw-text-primary-darker'
								: (isDeletedCfg(secondaryHeader.trim())
											| async) === true
								  ? 'tw-bg-warning-100 tw-text-primary'
								  : (isAddedCfg(secondaryHeader.trim())
												| async) === true
								    ? 'tw-bg-success-300 tw-text-primary'
								    : (hasChangesCfg(secondaryHeader.trim())
													| async) === true
								      ? 'tw-bg-accent-100 tw-text-primary'
								      : 'tw-text-primary'
						"
						class="tw-cursor-pointer tw-border-b-2 tw-border-r-2 tw-border-solid tw-border-foreground-divider tw-text-center tw-font-bold">
						<div
							class="tw-cursor-pointer tw-text-center tw-font-bold tw-text-primary-darker">
							{{ secondaryHeader }}
						</div>
					</th>
				</ng-container>
			}
			@for (
				displayedColumn of headers | async;
				track valueTracker(i, displayedColumn);
				let i = $index
			) {
				<ng-container
					[matColumnDef]="displayedColumn.columnId"
					[sticky]="isSticky(displayedColumn.name)">
					<th
						mat-header-cell
						*matHeaderCellDef
						[ngClass]="
							displayedColumn.name !== 'feature' &&
							displayedColumn.name !== 'values' &&
							(_editable | async) === 'true'
								? (isACfgGroup(displayedColumn.name) | async)
									? (isAddedCfgGroup(
											displayedColumn.name.trim()
									  ) | async) === true
										? 'tw-bg-success-300 tw-text-primary-darker'
										: (isDeletedCfgGroup(
													displayedColumn.name.trim()
										    ) | async) === true
										  ? 'tw-bg-warning-100 tw-text-primary-darker'
										  : (hasChangesCfgGroup(
														displayedColumn.name.trim()
										      ) | async) === true
										    ? 'tw-bg-accent-100 tw-text-primary-darker'
										    : 'tw-text-primary-darker'
									: (isDeletedCfg(displayedColumn.name.trim())
												| async) === true
									  ? 'tw-bg-warning-100 tw-text-primary'
									  : (isAddedCfg(displayedColumn.name.trim())
													| async) === true
									    ? 'tw-bg-success-300 tw-text-primary'
									    : (hasChangesCfg(
														displayedColumn.name.trim()
									        ) | async) === true
									      ? 'tw-bg-accent-100 tw-text-primary'
									      : 'tw-text-primary'
								: ''
						"
						class="tw-cursor-pointer tw-border-b-2 tw-border-r-2 tw-border-solid tw-border-foreground-divider tw-text-center tw-font-bold">
						@if (displayedColumn.name === 'feature') {
							<div
								mat-sort-header
								[id]="displayedColumn.columnId"
								start="asc"
								class="tw-font-bold">
								Feature
							</div>
						}
						@if (
							{
								isCfgGroup:
									(isACfgGroup(displayedColumn.name) | async),
								editable: (_editable | async)
							};
							as configSettings
						) {
							@if (
								displayedColumn.name !== 'feature' &&
									displayedColumn.name !== 'values' &&
									configSettings.editable;
								as _editable_
							) {
								<div
									mat-header-cell
									[id]="displayedColumn.columnId"
									[ngClass]="
										(isACfgGroup(displayedColumn.name)
										| async)
											? 'tw-cursor-pointer tw-text-center tw-font-bold tw-text-primary-darker'
											: (isDeletedCfg(
														displayedColumn.name.trim()
											    ) | async) === true
											  ? 'tw-cursor-pointer tw-bg-warning-100 tw-text-center tw-font-bold tw-text-primary'
											  : (isAddedCfg(
															displayedColumn.name.trim()
											      ) | async) === true
											    ? 'tw-cursor-pointer tw-bg-success-300 tw-text-center tw-font-bold tw-text-primary'
											    : 'tw-cursor-pointer tw-text-center tw-font-bold tw-text-primary'
									"
									(click)="
										openConfigMenu(
											displayedColumn.name,
											_editable_
										)
									"
									(contextmenu)="
										openContextMenu(
											$event,
											configSettings.isCfgGroup
												? 'GROUP'
												: 'CONFIG',
											displayedColumn.name.trim()
										)
									"
									[attr.data-cy]="
										(isACfgGroup(displayedColumn.name)
										| async)
											? 'tw-font-bold tw-text-center tw-cursor-pointer tw-text-primary-darker' +
											  displayedColumn.name
											: 'tw-font-bold tw-text-center tw-cursor-pointer tw-text-primary' +
											  displayedColumn.name
									">
									{{ displayedColumn.name }}
								</div>
							}
						}
						@if (displayedColumn.name === 'values') {
							<div
								mat-header-cell
								[id]="displayedColumn.columnId"></div>
						}
					</th>
					@if (
						displayedColumn.name === 'valueType' ||
						displayedColumn.name === 'productApplicabilities' ||
						displayedColumn.name === 'defaultValue' ||
						displayedColumn.name === 'multiValued'
					) {
						<div>
							<td
								mat-cell
								*matCellDef="let element"
								class="tw-px-1">
								{{ element[displayedColumn.name] }}
							</td>
						</div>
					}
					@if (displayedColumn.name === 'feature') {
						<div>
							<td
								mat-cell
								class="tw-cursor-pointer tw-border-b-0 tw-border-r-2 tw-border-solid tw-border-foreground-divider tw-px-1"
								*matCellDef="let element; index as r"
								[matTooltip]="element['description']"
								matTooltipClass="tw-text-base"
								(click)="displayFeatureMenu(element)"
								[ngClass]="
									r % 2 === 0
										? element.added
											? 'tw-bg-success-100'
											: element.deleted
											  ? 'tw-bg-warning-100'
											  : element.changes !== undefined
											    ? 'tw-bg-accent-100'
											    : 'tw-bg-background-card'
										: element.added
										  ? 'tw-bg-success-300'
										  : element.deleted
										    ? 'tw-bg-warning-100'
										    : element.changes !== undefined
										      ? 'tw-bg-accent-100'
										      : 'tw-bg-background-background'
								"
								(contextmenu)="
									openContextMenu($event, 'FEATURE', element)
								"
								[attr.data-cy]="'feature-' + element['name']">
								@if (isCompoundApplic(element['name'])) {
									@for (
										name of getCompoundApplicLines(
											element['name']
										);
										track name
									) {
										{{ name }}
										<br />
									}
								}
								@if (!isCompoundApplic(element['name'])) {
									{{ element['name'] }}
								}
							</td>
						</div>
					}
					@if (
						displayedColumn.name !== 'feature' &&
						displayedColumn.name !== 'description' &&
						displayedColumn.name !== 'values' &&
						displayedColumn.name !== 'valueType' &&
						displayedColumn.name !== 'productApplicabilities' &&
						displayedColumn.name !== 'defaultValue' &&
						displayedColumn.name !== 'multiValued'
					) {
						<div>
							<td
								mat-cell
								class="tw-border-b-0 tw-border-r-2 tw-border-solid tw-border-foreground-divider tw-px-1"
								*matCellDef="let element; index as r"
								[ngClass]="
									r % 2 === 0
										? element.added
											? 'tw-bg-success-100'
											: element.deleted
											  ? 'tw-bg-warning-100'
											  : 'tw-bg-background-card'
										: element.added
										  ? 'tw-bg-success-300'
										  : element.deleted
										    ? 'tw-bg-warning-100'
										    : 'tw-bg-background-background'
								">
								@for (
									config of getUniqueConfigurations(
										element.configurations
									);
									track config
								) {
									@if (
										isCorrectConfiguration(
											config,
											displayedColumn.name
										)
									) {
										@if (
											(_editable | async) === 'false' ||
											(isACfgGroup(config.name)
												| async) ||
											(isDeletedCfg(config.name)
												| async) === true ||
											(isDeletedCfgGroup(config.name)
												| async) === true ||
											isCompoundApplic(element.name)
										) {
											<div
												[ngClass]="
													(_editable | async) ===
													'true'
														? (isAddedCfg(
																config.name
														  ) | async) === true ||
														  ((isAddedCfgGroup(
																config.name
														  ) | async) === true &&
																!element.deleted)
															? 'selectApplicabilityTableOption tw-bg-success-300'
															: (isDeletedCfg(
																		config.name
															    ) | async) ===
																		true ||
															    (isDeletedCfgGroup(
																		config.name
															    ) | async) ===
																		true
															  ? 'selectApplicabilityTableOption tw-bg-warning-100'
															  : config.changes !==
															      undefined
															    ? 'selectApplicabilityTableOption tw-bg-accent-100'
															    : 'selectApplicabilityTableOption'
														: (isAddedCfg(
																	config.name
														    ) | async) === true
														  ? 'tw-bg-success-300'
														  : (isDeletedCfg(
																		config.name
														      ) | async) ===
														      true
														    ? 'tw-bg-warning-100'
														    : config.changes !==
														        undefined
														      ? 'selectApplicabilityTableOption tw-bg-accent-100'
														      : 'selectApplicabilityTableOption'
												"
												(contextmenu)="
													openContextMenu(
														$event,
														'VALUE',
														config
													)
												"
												[attr.data-cy]="
													'value-' +
													sortMultiValue(
														config.values
													) +
													'-' +
													displayedColumn.name +
													'-' +
													element.name
												">
												<mat-label>{{
													config.value
												}}</mat-label>
											</div>
										} @else {
											@if (element.values.length !== 0) {
												@if (element.multiValued) {
													<div
														[ngClass]="
															(isAddedCfg(
																config.name
															) | async) ===
																true &&
															!element.deleted
																? r % 2 === 0
																	? 'applicabilityTableMatSelect MatSelectConfig tw-bg-success-100'
																	: 'applicabilityTableMatSelect MatSelectConfig tw-bg-success-300'
																: config.changes !==
																    undefined
																  ? 'applicabilityTableMatSelect MatSelectConfig tw-bg-accent-100'
																  : 'applicabilityTableMatSelect MatSelectConfig'
														"
														(contextmenu)="
															openContextMenu(
																$event,
																'VALUE',
																config
															)
														">
														<mat-form-field
															subscriptSizing="dynamic"
															[ngClass]="
																(isAddedCfg(
																	config.name
																) | async) ===
																	true &&
																!element.deleted
																	? r % 2 ===
																	  0
																		? 'selectApplicabilityTableOption tw-bg-success-100'
																		: 'selectApplicabilityTableOption tw-bg-success-300'
																	: (isDeletedCfg(
																				config.name
																	    )
																				| async) ===
																	    true
																	  ? 'selectApplicabilityTableOption tw-bg-warning-100'
																	  : config.changes
																	    ? 'selectApplicabilityTableOption tw-bg-accent-100'
																	    : 'selectApplicabilityTableOption'
															"
															id="selectableTableOption"
															class="tw-w-full [&>.mdc-text-field--filled]:tw-bg-inherit">
															<mat-select
																[(ngModel)]="
																	config.values
																"
																(selectionChange)="
																	modifyConfiguration(
																		displayedColumn.name,
																		element,
																		$event
																	)
																"
																multiple
																[attr.data-cy]="
																	'value-' +
																	sortMultiValue(
																		config.values
																	) +
																	'-' +
																	displayedColumn.name +
																	'-' +
																	element.name
																">
																@for (
																	value of element.values;
																	track value
																) {
																	@if (
																		{
																			result:
																				applicIsNotPermitted(
																					displayedColumn.name,
																					element,
																					value
																				)
																				| async
																		};
																		as isNotPermitted
																	) {
																		<mat-option
																			[value]="
																				value
																			"
																			[attr.data-cy]="
																				'option-' +
																				value +
																				'-' +
																				config.values.includes(
																					value
																				)
																			"
																			[disabled]="
																				isNotPermitted.result
																			">
																			@if (
																				isNotPermitted.result
																			) {
																				<del
																					>{{
																						value
																					}}</del
																				>
																			} @else {
																				{{
																					value
																				}}
																			}
																		</mat-option>
																	}
																}
															</mat-select>
														</mat-form-field>
													</div>
												} @else {
													<div
														[ngClass]="
															(isAddedCfg(
																config.name
															) | async) ===
																true &&
															!element.deleted
																? r % 2 === 0
																	? 'applicabilityTableMatSelect MatSelectProduct tw-bg-success-100'
																	: 'applicabilityTableMatSelect MatSelectProduct tw-bg-success-300'
																: config.changes !==
																    undefined
																  ? 'applicabilityTableMatSelect MatSelectProduct tw-bg-accent-100'
																  : 'applicabilityTableMatSelect MatSelectProduct'
														"
														(contextmenu)="
															openContextMenu(
																$event,
																'VALUE',
																config
															)
														">
														<mat-form-field
															subscriptSizing="dynamic"
															[ngClass]="
																(isAddedCfg(
																	config.name
																) | async) ===
																	true &&
																!element.deleted
																	? r % 2 ===
																	  0
																		? 'selectApplicabilityTableOption tw-bg-success-100'
																		: 'selectApplicabilityTableOption tw-bg-success-300'
																	: (isDeletedCfg(
																				config.name
																	    )
																				| async) ===
																	    true
																	  ? 'selectApplicabilityTableOption tw-bg-warning-100'
																	  : config.changes !==
																	      undefined
																	    ? 'selectApplicabilityTableOption tw-bg-accent-100'
																	    : 'selectApplicabilityTableOption'
															"
															id="selectableTableOption"
															class="tw-w-full [&>.mdc-text-field--filled]:tw-bg-inherit">
															<mat-select
																[(ngModel)]="
																	config.value
																"
																(selectionChange)="
																	modifyProduct(
																		displayedColumn.name,
																		element,
																		$event
																	)
																"
																[attr.data-cy]="
																	'value-' +
																	config.value +
																	'-' +
																	displayedColumn.name +
																	'-' +
																	element.name
																">
																@for (
																	value of element.values;
																	track value
																) {
																	@if (
																		{
																			result:
																				applicIsNotPermitted(
																					displayedColumn.name,
																					element,
																					value
																				)
																				| async
																		};
																		as isNotPermitted
																	) {
																		<mat-option
																			[value]="
																				value
																			"
																			[attr.data-cy]="
																				'option-' +
																				value +
																				'-' +
																				config.values.includes(
																					value
																				)
																			"
																			[disabled]="
																				isNotPermitted.result
																			">
																			@if (
																				isNotPermitted.result
																			) {
																				<del
																					>{{
																						value
																					}}</del
																				>
																			} @else {
																				{{
																					value
																				}}
																			}
																		</mat-option>
																	}
																}
															</mat-select>
														</mat-form-field>
													</div>
												}
											}
										}
									}
								}
							</td>
						</div>
					}
				</ng-container>
			}
			<tr
				mat-header-row
				*matHeaderRowDef="topLevelHeaders | async; sticky: true"></tr>
			<tr
				mat-header-row
				*matHeaderRowDef="secondaryHeaders | async; sticky: true"></tr>
			<tr
				mat-header-row
				*matHeaderRowDef="columnIds | async; sticky: true"></tr>
			<tr
				mat-row
				*matRowDef="let row; columns: columnIds | async"
				class="config-table-row tw-h-12"></tr>
			<tr *matNoDataRow>
				<td
					class="tw-p-4"
					colspan="(viewCount|async)+(groupCount|async)+1">
					No data matching filter
				</td>
			</tr>
		</table>
	</div>
</div>
<mat-paginator [pageSizeOptions]="[10, 15, 25, 100]"></mat-paginator>
@if ((errors | async)!.length > 0) {
	<mat-error>{{ errors | async }}</mat-error>
}
<mat-menu #featureMenu="matMenu">
	<ng-template
		matMenuContent
		let-feature="feature">
		<osee-plconfig-feature-menu
			[feature]="feature"></osee-plconfig-feature-menu>
	</ng-template>
</mat-menu>
<mat-menu #configMenu="matMenu">
	<ng-template
		matMenuContent
		let-config="config">
		<osee-plconfig-config-menu
			[config]="
				(config | async) || {
					name: '',
					description: '',
					hasFeatureApplicabilities: false,
					id: ''
				}
			"></osee-plconfig-config-menu>
	</ng-template>
</mat-menu>
<mat-menu #configGroupMenu="matMenu">
	<ng-template
		matMenuContent
		let-group="group">
		<osee-plconfig-config-group-menu
			[group]="
				(group | async) || {
					name: '',
					description: '',
					id: '',
					configurations: []
				}
			"></osee-plconfig-config-group-menu>
	</ng-template>
</mat-menu>
<mat-menu #valueMenu="matMenu">
	<ng-template
		matMenuContent
		let-value="value">
		<osee-plconfig-value-menu [value]="value"></osee-plconfig-value-menu>
	</ng-template>
</mat-menu>
<div
	#featureMenuTrigger="matMenuTrigger"
	style="visibility: hidden; position: fixed"
	[style.left]="menuPosition.x"
	[style.top]="menuPosition.y"
	[matMenuTriggerFor]="featureMenu"
	class="featureMenu">
	LinkMenu
</div>
<div
	#configMenuTrigger="matMenuTrigger"
	style="visibility: hidden; position: fixed"
	[style.left]="menuPosition.x"
	[style.top]="menuPosition.y"
	[matMenuTriggerFor]="configMenu"
	class="configMenuTrigger">
	NodeMenu
</div>
<div
	#configGroupMenuTrigger="matMenuTrigger"
	style="visibility: hidden; position: fixed"
	[style.left]="menuPosition.x"
	[style.top]="menuPosition.y"
	[matMenuTriggerFor]="configGroupMenu"
	class="configGroupMenuTrigger">
	GraphMenu
</div>
<div
	#valueMenuTrigger="matMenuTrigger"
	style="visibility: hidden; position: fixed"
	[style.left]="menuPosition.x"
	[style.top]="menuPosition.y"
	[matMenuTriggerFor]="valueMenu"
	class="valueMenuTrigger">
	GraphMenu
</div>
