<!--
* Copyright (c) 2021 Boeing
*
* This program and the accompanying materials are made
* available under the terms of the Eclipse Public License 2.0
* which is available at https://www.eclipse.org/legal/epl-2.0/
*
* SPDX-License-Identifier: EPL-2.0
*
* Contributors:
*     Boeing - initial API and implementation
-->
@if (inDiffMode | async; as _diff) {
	<div #topOfTable>
		@if (currentStructureHeaders | async; as currentHeaders) {
			@if (isEditing() && !tableFieldsEditMode()) {
				<div
					class="tw-w-full tw-bg-primary-100 tw-px-4 tw-py-2 dark:tw-bg-primary-500">
					The element tables are in limited editing mode due to the
					number elements present in the structures. Right click
					elements to edit.
				</div>
			}
			<table
				mat-table
				[dataSource]="structures()"
				multiTemplateDataRows
				[trackBy]="structureTracker"
				class="mat-elevation-z7 tw-w-full">
				<ng-container matColumnDef="Breadcrumbs">
					<th
						mat-header-cell
						*matHeaderCellDef
						[attr.colspan]="currentHeaders.length"
						class="tw-flex-[1_1_auto] tw-truncate tw-text-center tw-text-sm tw-text-primary-600 hover:tw-cursor-pointer"
						[routerLink]="previousLink()"
						queryParamsHandling="merge">
						{{ breadCrumb() }}
					</th>
				</ng-container>
				@for (
					header of currentHeaders;
					track valueTracker(i, header);
					let i = $index
				) {
					<ng-container [matColumnDef]="header.toString()">
						<th
							mat-header-cell
							*matHeaderCellDef
							class="tw-flex-[1_1_auto] tw-truncate tw-text-center tw-text-sm tw-text-primary-600"
							[ngClass]="{
								'tw-w-[5%] tw-flex-[0_0_5%]':
									header === ' ' ||
									header === 'interfaceMaxSimultaneity' ||
									header === 'interfaceMinSimultaneity',
								'tw-max-w-[200px] tw-flex-[2_2_10%]':
									header === 'name',
								'tw-flex-[3_1_50%]': header === 'description',
								'tw-w-8% tw-flex-[0_0_8%]':
									header === 'interfaceTaskFileType',
								'tw-max-w-[100px]':
									header === 'interfaceMinSimultaneity' ||
									header === 'interfaceMaxSimultaneity' ||
									header === 'interfaceTaskFileType' ||
									header === 'numElements' ||
									header === 'sizeInBytes',
								'tw-max-w-[75px]':
									header === 'bytesPerSecondMinimum' ||
									header === 'bytesPerSecondMaximum' ||
									header === 'txRate',
								'tw-max-w-[120px]':
									header === 'interfaceStructureCategory',
								'tw-max-w-[175px]': header === 'applicability',
							}"
							[matTooltip]="
								(getHeaderByName(header) | async)
									?.description || ''
							"
							[attr.data-cy]="'structure-table-header-' + header">
							{{
								(getHeaderByName(header) | async)
									?.humanReadable || ''
							}}
						</th>
						<td
							mat-cell
							*matCellDef="let structure; let i = dataIndex"
							class="tw-flex-[1_1_auto] tw-truncate tw-px-0 tw-py-1 tw-text-center"
							[ngClass]="{
								'tw-bg-accent-100 tw-text-background-app-bar':
									structure &&
									structure.changes &&
									structure.changes[header] !== undefined,
								'tw-w-[5%] tw-flex-[0_0_5%]':
									header === ' ' ||
									header === 'interfaceMaxSimultaneity' ||
									header === 'interfaceMinSimultaneity',
								'tw-max-w-[200px] tw-flex-[2_2_10%] tw-text-justify':
									header === 'name',
								'tw-flex-[3_1_50%]': header === 'description',
								'tw-w-8% tw-flex-[0_0_8%]':
									header === 'interfaceTaskFileType',
								'tw-max-w-[100px]':
									header === 'interfaceMinSimultaneity' ||
									header === 'interfaceMaxSimultaneity' ||
									header === 'interfaceTaskFileType' ||
									header === 'numElements' ||
									header === 'sizeInBytes',
								'tw-max-w-[75px]':
									header === 'bytesPerSecondMinimum' ||
									header === 'bytesPerSecondMaximum' ||
									header === 'txRate',
								'tw-max-w-[120px]':
									header === 'interfaceStructureCategory',
								'tw-max-w-[175px]': header === 'applicability',
							}"
							[ngStyle]="{
								width: (layout | async)?.tableRecommendations
									?.width,
							}"
							(contextmenu)="
								openMenu(
									$event,
									structure.id,
									structure.name.value,
									structure.description,
									structure,
									header,
									_diff
								)
							">
							@if (
								isEditing() === true && !structure.autogenerated
							) {
								@if (headerIsEditable(header)) {
									@switch (header) {
										@case ('applicability') {
											<form
												#defaultForm="ngForm"
												[artifactId]="structure.id"
												oseeStructureImpactsValidator>
												<osee-persisted-applicability-dropdown
													[artifactId]="structure.id"
													[(applicability)]="
														structure.applicability
													"></osee-persisted-applicability-dropdown>
											</form>
										}
										@case ('nameAbbrev') {
											<form
												#defaultForm="ngForm"
												[artifactId]="structure.id"
												oseeStructureImpactsValidator>
												<osee-persisted-string-attribute-input
													[artifactId]="structure.id"
													[artifactApplicability]="
														structure.applicability
													"
													[(value)]="
														structure[header]
													"
													maxlength="31"
													[tooltip]="
														structure[header].value
															.length +
														'/31 characters'
													">
												</osee-persisted-string-attribute-input>
											</form>
										}
										@case ('interfaceStructureCategory') {
											<form
												#defaultForm="ngForm"
												[artifactId]="structure.id"
												oseeStructureImpactsValidator>
												<osee-persisted-structure-category-dropdown
													[artifactId]="structure.id"
													[artifactApplicability]="
														structure.applicability
													"
													[(value)]="
														structure[header]
													"
													[hintHidden]="true" />
											</form>
										}
										@default {
											<form
												#defaultForm="ngForm"
												[artifactId]="structure.id"
												oseeStructureImpactsValidator>
												<osee-persisted-string-attribute-input
													[artifactId]="structure.id"
													[artifactApplicability]="
														structure.applicability
													"
													[(value)]="
														structure[header]
													">
												</osee-persisted-string-attribute-input>
											</form>
										}
									}
								} @else {
									<osee-structure-table-no-edit-field
										[structure]="structure"
										[header]="header"
										[message]="message()" />
								}
							} @else if (
								isEditing() === false || structure.autogenerated
							) {
								<osee-structure-table-no-edit-field
									[structure]="structure"
									[header]="header"
									[message]="message()" />
							}
						</td>
					</ng-container>
				}
				<ng-container matColumnDef="expandedMessage">
					<td
						mat-cell
						class="tw-flex-[1_1_auto] tw-truncate"
						*matCellDef="let structure"
						[attr.colspan]="currentHeaders.length"
						class="first:tw-pl-[1%]">
						<div
							class="tw-flex tw-w-full tw-max-w-[100vw] tw-flex-col tw-overflow-hidden"
							[@detailExpand]="
								rowIsExpanded(structure.id)
									? 'expanded'
									: 'collapsed'
							">
							@if (rowIsExpanded(structure.id)) {
								<osee-messaging-message-element-interface-sub-element-table
									[data]="structure.elements"
									[filter]="structureFilter()"
									[structure]="structure"
									[elementHeaders]="
										(currentElementHeaders | async) || []
									"
									[editMode]="isEditing()"
									[tableFieldsEditMode]="
										tableFieldsEditMode()
									"></osee-messaging-message-element-interface-sub-element-table>
							}
						</div>
					</td>
				</ng-container>
				<tr
					mat-header-row
					*matHeaderRowDef="['Breadcrumbs']; sticky: true"></tr>
				<tr
					mat-header-row
					*matHeaderRowDef="currentHeaders; sticky: true"></tr>
				<tr
					mat-row
					*matRowDef="let row; columns: currentHeaders; let k = index"
					class="tw-transition-colors tw-duration-300 tw-ease-in-out hover:tw-bg-background-hover hover:tw-font-extrabold [&>td]:tw-flex-nowrap [&>td]:tw-border-b-0"
					[ngClass]="{
						'even-multi:tw-bg-success-100 odd-multi:tw-bg-success-300 even-multi:dark:tw-bg-success-600 odd-multi:dark:tw-bg-success-900':
							row.added,
						'even-multi:tw-bg-warn-100 odd-multi:tw-bg-warn-200':
							row.deleted,
						'even-multi:tw-bg-accent-100 odd-multi:tw-bg-accent-200 even-multi:dark:tw-bg-accent-700 even-multi:dark:hover:tw-bg-accent-600 odd-multi:dark:tw-bg-accent-800 odd-multi:dark:hover:tw-bg-accent-700 even-multi:dark:[&>*]:tw-text-background-app-bar odd-multi:dark:[&>*]:tw-text-background-app-bar even-multi:dark:[&>td>*>*>*]:tw-text-background-app-bar':
							row.autogenerated,
						'tw-h-0 tw-flex-nowrap': rowIsExpanded(row.id),
						'even-multi:tw-bg-background-background odd-multi:tw-bg-background-selected-button':
							!row.autogenerated && !row.added && !row.deleted,
					}"></tr>
				<tr
					mat-row
					*matRowDef="let row; columns: ['expandedMessage']"
					class="tw-h-0 tw-flex-nowrap"></tr>
			</table>
		}
	</div>
}
<osee-structure-menu
	[(menuData)]="menuMetaData"
	[breadCrumb]="breadCrumb()"
	[isEditing]="isEditing()" />
