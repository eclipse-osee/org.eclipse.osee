<!--
 * Copyright (c) 2023 Boeing
 *
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 *     Boeing - initial API and implementation
 -->
<ng-container>
	<div class="scrolling-container">
		<button
			mat-raised-button
			class="light-button"
			(click)="manageAllRows(true)">
			Expand All
		</button>
		<button
			mat-raised-button
			class="light-button"
			(click)="manageAllRows(false)">
			Collpase All
		</button>
		<button
			mat-raised-button
			class="light-button"
			(click)="exportDataAsCsv()">
			Export Displayed Data to CSV
		</button>
		<ng-container *ngIf="link | async as _link">
			<button
				mat-raised-button
				class="light-button"
				(click)="exportAllDataAsCsv(_link)">
				Export All Data to CSV
			</button>
		</ng-container>
		<div>
			<mat-form-field
				subscriptSizing="dynamic"
				class="tw-py-4">
				<input
					matInput
					class="form-field"
					[formControl]="workflowFilter"
					placeholder="Filter Workflow ID" /><mat-icon matPrefix
					>filter_list</mat-icon
				></mat-form-field
			>
		</div>

		<table
			mat-table
			class="report-table mat-elevation-z8"
			matSortDisableClear
			matSortDirection="asc"
			[dataSource]="dataSource"
			matSort
			multiTemplateDataRows>
			<ng-container matColumnDef="workflowID">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					class="header-cell">
					Workflow ID
				</th>
				<td
					mat-cell
					class="row-cell"
					*matCellDef="let artifact">
					{{ artifact.workflowID }}
					<ng-container *ngIf="link | async as _link">
						<ng-container *ngIf="artifact.changeReport">
							<br />
							<a href="{{ _link + artifact.changeReport }}"
								>REQ</a
							>
						</ng-container>
						<ng-container *ngIf="artifact.icdDiff">
							<br /><a
								target="_blank"
								href="{{ _link + artifact.icdDiff }}"
								>ICD</a
							>
						</ng-container>
					</ng-container>
				</td>
			</ng-container>

			<ng-container matColumnDef="program">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					class="header-cell">
					Program
				</th>
				<td
					mat-cell
					class="row-cell"
					*matCellDef="let artifact">
					{{ artifact.program }}
				</td>
			</ng-container>

			<ng-container matColumnDef="build">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					class="header-cell">
					Build
				</th>
				<td
					mat-cell
					class="row-cell"
					*matCellDef="let artifact">
					{{ artifact.build }}
				</td>
			</ng-container>

			<ng-container matColumnDef="state">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					class="header-cell">
					State
				</th>
				<td
					mat-cell
					class="row-cell"
					*matCellDef="let artifact">
					{{ artifact.state }}
				</td>
			</ng-container>

			<ng-container matColumnDef="description">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					class="header-cell">
					Description
				</th>
				<td
					mat-cell
					class="row-cell"
					*matCellDef="let artifact">
					{{ artifact.description }}
				</td>
			</ng-container>

			<ng-container matColumnDef="actions">
				<th
					mat-header-cell
					*matHeaderCellDef
					class="header-cell">
					Actions
				</th>
				<td
					mat-cell
					class="row-cell"
					mat-raised-button
					*matCellDef="let artifact">
					<a
						mat-button
						(click)="toggleRow(artifact)"
						>{{ artifact.expanded ? 'Collapse' : 'Expand' }}</a
					>
				</td>
			</ng-container>

			<!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
			<ng-container matColumnDef="expandedDetail">
				<td
					mat-cell
					*matCellDef="let element"
					[attr.colspan]="displayedColumns.length">
					<div
						class="element-detail"
						[@detailExpand]="
							element.expanded || allRowsExpanded
								? 'expanded'
								: 'collapsed'
						">
						<table class="detail-table">
							<tr mat-cell>
								<th
									mat-header-cell
									class="header-cell">
									Requirement
								</th>
								<th
									mat-header-cell
									class="header-cell">
									Test
								</th>
							</tr>
							<tr
								class="detail-table-row-border"
								*ngFor="
									let requirement of element.requirements
								">
								<td mat-cell>
									{{ requirement.name }}
								</td>
								<td mat-cell>
									<tr
										mat-cell
										*ngFor="let test of requirement.tests">
										{{
											getTestTd(test)
										}}
									</tr>
								</td>
							</tr>
						</table>
					</div>
				</td>
			</ng-container>

			<tr
				mat-header-row
				*matHeaderRowDef="displayedColumns; sticky: true"></tr>

			<tr
				mat-row
				*matRowDef="let artifact; columns: displayedColumns"></tr>

			<tr
				mat-row
				*matRowDef="let row; columns: ['expandedDetail']"
				class="detail-row"></tr>
		</table>
	</div>
	<ng-container *ngIf="artifactData | async as _data">
		<mat-paginator
			#paginator
			[length]="queryCount | async"
			[pageIndex]="page"
			[pageSize]="pageSize"
			[pageSizeOptions]="[10, 25, 50, 100, 200]"
			(page)="setPaginatorState($event)"
			showFirstLastButtons
			[disabled]="false"></mat-paginator
	></ng-container>
</ng-container>
