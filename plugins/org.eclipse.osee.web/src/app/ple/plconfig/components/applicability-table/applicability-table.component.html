<!--
 * Copyright (c) 2021 Boeing
 *
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 *     Boeing - initial API and implementation
 -->
<div class="mat-elevation-z8">
    <mat-form-field>
        <mat-label>Filter Configuration Information</mat-label>
        <input matInput type="text" (keyup)="applyFilter($event)" #input>
        <mat-hint>Enter text to filter Configuration Table</mat-hint>
    </mat-form-field>
    <div class="table-container">
        <table mat-table  [dataSource]="(dataSource|async)||[]" matSort matSortActive="feature" matSortDirection="asc" class="mat-elevation-z8">
            <ng-container matColumnDef=" ">
                <th mat-header-cell *matHeaderCellDef colspan="1" class="applic-table-header"> </th>
            </ng-container>
            <ng-container matColumnDef="Configurations">
                <th mat-header-cell *matHeaderCellDef [attr.colspan]="viewCount|async" class="applic-table-header">Configurations</th>
            </ng-container>
            <ng-container matColumnDef="Groups">
                <th mat-header-cell *matHeaderCellDef [attr.colspan]="groupCount|async" class="applic-table-header">Configuration Groups</th>
            </ng-container>
            <ng-container [matColumnDef]="secondaryHeader" *ngFor="let secondaryHeader of (secondaryHeaders | async); let i = index; trackBy:valueTracker;">
                <th mat-header-cell *matHeaderCellDef [attr.colspan]="(secondaryHeaderLength|async)![i]" [ngClass]="(isACfgGroup(secondaryHeader.trim())|async)?(isAddedCfgGroup(secondaryHeader.trim())|async)===true?'config-group-header applic-table-column-added': (isDeletedCfgGroup(secondaryHeader.trim())|async)===true?'config-group-header applic-table-column-deleted':(hasChangesCfgGroup(secondaryHeader.trim())|async)===true?'config-group-header applic-table-column-changed':'config-group-header':(isDeletedCfg(secondaryHeader.trim())|async)===true?'applic-table-column-deleted config-header':(isAddedCfg(secondaryHeader.trim())|async)===true?'applic-table-column-added config-header':(hasChangesCfg(secondaryHeader.trim())|async)===true?'config-header applic-table-column-changed':'config-header'">
                    <div class="config-group-header">
                        {{secondaryHeader}}
                    </div>
                </th>
            </ng-container>
            <ng-container [matColumnDef]="displayedColumn" *ngFor="let displayedColumn of (headers | async); let i = index; trackBy:valueTracker;" [sticky]="isSticky(displayedColumn)">
                <th mat-header-cell *matHeaderCellDef [ngClass]="displayedColumn !== 'feature' && displayedColumn !=='values' && (_editable | async)==='true'? (isACfgGroup(displayedColumn)|async)?(isAddedCfgGroup(displayedColumn.trim())|async)===true?'config-group-header applic-table-column-added': (isDeletedCfgGroup(displayedColumn.trim())|async)===true?'config-group-header applic-table-column-deleted':(hasChangesCfgGroup(displayedColumn.trim())|async)===true?'config-group-header applic-table-column-changed':'config-group-header':(isDeletedCfg(displayedColumn.trim())|async)===true?'applic-table-column-deleted config-header':(isAddedCfg(displayedColumn.trim())|async)===true?'applic-table-column-added config-header':(hasChangesCfg(displayedColumn.trim())|async)===true?'config-header applic-table-column-changed':'config-header':''">
                    <div mat-sort-header [id]="displayedColumn" *ngIf="displayedColumn === 'feature'" start='asc' style="font-weight:bold;">
                        {{displayedColumn}}
                    </div>
                    <ng-container *ngIf="{isCfgGroup:(isACfgGroup(displayedColumn)|async), editable:(_editable | async)} as configSettings">
                        <div mat-header-cell [id]="displayedColumn" *ngIf="displayedColumn !== 'feature' && displayedColumn !=='values' && configSettings.editable as _editable_ " [ngClass]="(isACfgGroup(displayedColumn)|async)? 'config-group-header':(isDeletedCfg(displayedColumn.trim())|async)===true?'applic-table-column-deleted config-header':(isAddedCfg(displayedColumn.trim())|async)===true?'applic-table-column-added config-header':'config-header'" (click)="openConfigMenu(displayedColumn, _editable_)" (contextmenu)="openContextMenu($event,configSettings.isCfgGroup?'GROUP':'CONFIG',displayedColumn.trim())">
                            {{displayedColumn}}
                        </div>
                    </ng-container>
                    <div mat-header-cell [id]="displayedColumn" *ngIf="displayedColumn === 'values'"></div>
                </th>
                <div *ngIf="  
                displayedColumn === 'valueType'|| 
                displayedColumn === 'productApplicabilities'|| 
                displayedColumn === 'defaultValue'|| 
                displayedColumn === 'multiValued'">
                    <td mat-cell *matCellDef="let element">
                        {{element[displayedColumn]}}
                    </td>
                </div>
                <div *ngIf=" 
                displayedColumn === 'feature'">
                    <td mat-cell *matCellDef="let element; index as r" [matTooltip]="element['description']" style="padding-right:10%;cursor:pointer" (click)="displayFeatureMenu(element)" [ngClass]="r%2===0?element.added?'applic-table-row-even-added':element.deleted?'applic-table-row-even-deleted':element.changes!==undefined?'applic-table-row-even-changed':'applic-table-row-even':element.added?'applic-table-row-odd-added':element.deleted?'applic-table-row-odd-deleted':element.changes!==undefined?'applic-table-row-odd-changed':'applic-table-row-odd'" (contextmenu)="openContextMenu($event,'FEATURE',element)" >
                        {{element['name']}}
                    </td>
                </div>
                <div *ngIf="displayedColumn !=='feature' &&
                 displayedColumn !== 'description' && 
                 displayedColumn !=='values' && 
                 displayedColumn !=='valueType' && 
                 displayedColumn !=='productApplicabilities' && 
                 displayedColumn !=='defaultValue' && 
                 displayedColumn !=='multiValued'">
                            <td mat-cell *matCellDef="let element; index as r" [ngClass]="r%2===0?element.added?'applic-table-row-even-added':element.deleted?'applic-table-row-even-deleted':'applic-table-row-even':element.added?'applic-table-row-odd-added':element.deleted?'applic-table-row-odd-deleted':'applic-table-row-odd'" >
                                <ng-container *ngFor="let config of element.configurations">
                                    <ng-container *ngIf="isCorrectConfiguration(config,displayedColumn)">
                                        <div *ngIf="(_editable | async) === 'false' || (isACfgGroup(config.name)|async) ||(isDeletedCfg(config.name)|async)===true ||(isDeletedCfgGroup(config.name)|async)===true;else edit_content;" [ngClass]="(_editable | async) === 'true'? (isAddedCfg(config.name)|async)===true||(isAddedCfgGroup(config.name)|async)===true && !element.deleted?'selectApplicabilityTableOption applic-table-column-added':(isDeletedCfg(config.name)|async)===true || (isDeletedCfgGroup(config.name)|async)===true?'selectApplicabilityTableOption applic-table-column-deleted':config.changes!==undefined?'selectApplicabilityTableOption applicabilityChanged':'selectApplicabilityTableOption':(isAddedCfg(config.name)|async)===true?'applic-table-column-added':(isDeletedCfg(config.name)|async)===true?'applic-table-column-deleted':config.changes!==undefined?'applicabilityChanged selectApplicabilityTableOption':'selectApplicabilityTableOption'" (contextmenu)="openContextMenu($event,'VALUE',config)">
                                            <mat-label>{{config.value}}</mat-label>
                                        </div>
                                        <ng-template #edit_content >
                                            <ng-container *ngIf="element.values.length!==0">
                                                <ng-container *ngIf="element.multiValued;else editProduct">
                                                    <div [ngClass]="(isAddedCfg(config.name)|async)===true && !element.deleted?r%2===0?'applicabilityTableMatSelect MatSelectConfig applic-table-column-added-row-even':'applicabilityTableMatSelect MatSelectConfig applic-table-column-added-row-odd':config.changes!==undefined?'applicabilityTableMatSelect MatSelectConfig applicabilityChanged':'applicabilityTableMatSelect MatSelectConfig'" (contextmenu)="openContextMenu($event,'VALUE',config)">
                                                        <mat-form-field [ngClass]="(isAddedCfg(config.name)|async)===true && !element.deleted?r%2===0?'selectApplicabilityTableOption applic-table-column-added-row-even':'selectApplicabilityTableOption applic-table-column-added-row-odd':(isDeletedCfg(config.name)|async)===true?'selectApplicabilityTableOption applic-table-column-deleted':config.changes?'selectApplicabilityTableOption applicabilityChanged':'selectApplicabilityTableOption'" id="selectableTableOption">
                                                            <mat-select [(ngModel)] = "config.values" (selectionChange)="modifyConfiguration(displayedColumn,element,$event)" multiple>
                                                                <mat-option *ngFor="let value of element.values" [value]="value">
                                                                    {{value}}
                                                                </mat-option>
                                                            </mat-select>
                                                        </mat-form-field>
                                                    </div>
                                                </ng-container>
                                                <ng-template #editProduct>
                                                    <div [ngClass]="(isAddedCfg(config.name)|async)===true && !element.deleted?r%2===0?'applicabilityTableMatSelect MatSelectProduct applic-table-column-added-row-even':'applicabilityTableMatSelect MatSelectProduct applic-table-column-added-row-odd':config.changes!==undefined?'applicabilityTableMatSelect MatSelectProduct applicabilityChanged':'applicabilityTableMatSelect MatSelectProduct'" (contextmenu)="openContextMenu($event,'VALUE',config)">
                                                        <mat-form-field [ngClass]="(isAddedCfg(config.name)|async)===true && !element.deleted?r%2===0?'selectApplicabilityTableOption applic-table-column-added-row-even':'selectApplicabilityTableOption applic-table-column-added-row-odd':(isDeletedCfg(config.name)|async)===true?'selectApplicabilityTableOption applic-table-column-deleted':config.changes!==undefined?'selectApplicabilityTableOption applicabilityChanged':'selectApplicabilityTableOption'" id="selectableTableOption">
                                                            <mat-select [(ngModel)]="config.value" (selectionChange)="modifyProduct(displayedColumn,element,$event)">
                                                                <mat-option *ngFor="let value of element.values" [value]="value">
                                                                    {{value}}
                                                                </mat-option>
                                                            </mat-select>
                                                        </mat-form-field>
                                                    </div>
                                                </ng-template>
                                            </ng-container>
                                        </ng-template>
                                    </ng-container>
                                </ng-container>
                            </td>
                </div>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="topLevelHeaders|async;sticky: true"></tr>
            <tr mat-header-row *matHeaderRowDef="secondaryHeaders|async; sticky:true"></tr>
            <tr mat-header-row *matHeaderRowDef="headers|async; sticky:true"></tr>
            <tr mat-row *matRowDef= "let row; columns: headers|async;" [ngClass]="(_editable | async) === 'false'? 'mat-title':''"></tr>
            <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" colspan="(viewCount|async)+(groupCount|async)+1">No data matching filter</td>
              </tr>
        </table>
    </div>
</div>
<mat-paginator [pageSizeOptions]="[10, 15, 25, 100]"></mat-paginator>
<mat-error *ngIf="(errors | async)!.length>0">{{errors |async}}</mat-error>
<mat-menu #featureMenu="matMenu">
    <ng-template matMenuContent let-feature="feature">
        <plconfig-feature-menu [feature]="feature"></plconfig-feature-menu>
    </ng-template>
</mat-menu>
<mat-menu #configMenu="matMenu">
    <ng-template matMenuContent let-config="config">
        <plconfig-config-menu [config]="(config|async)||{name:'',hasFeatureApplicabilities:false,id:''}"></plconfig-config-menu>
    </ng-template>
</mat-menu>
<mat-menu #configGroupMenu="matMenu">
    <ng-template matMenuContent let-group="group">
        <plconfig-config-group-menu [group]="(group|async)||{name:'',id:'',configurations:[]}"></plconfig-config-group-menu>
    </ng-template>
</mat-menu>
<mat-menu #valueMenu="matMenu">
    <ng-template matMenuContent let-value="value">
        <plconfig-value-menu [value]="value"></plconfig-value-menu>
    </ng-template>
</mat-menu>
<div #featureMenuTrigger="matMenuTrigger" style="visibility: hidden; position: fixed;"
[style.left]="menuPosition.x" 
[style.top]="menuPosition.y" 
[matMenuTriggerFor]="featureMenu" class='featureMenu'>LinkMenu
</div>
<div #configMenuTrigger="matMenuTrigger" style="visibility: hidden; position: fixed;"
[style.left]="menuPosition.x" 
[style.top]="menuPosition.y" 
[matMenuTriggerFor]="configMenu" class='configMenuTrigger'>NodeMenu
</div>
<div #configGroupMenuTrigger="matMenuTrigger" style="visibility: hidden; position: fixed;"
[style.left]="menuPosition.x" 
[style.top]="menuPosition.y" 
[matMenuTriggerFor]="configGroupMenu" class="configGroupMenuTrigger">GraphMenu
</div>
<div #valueMenuTrigger="matMenuTrigger" style="visibility: hidden; position: fixed;"
[style.left]="menuPosition.x" 
[style.top]="menuPosition.y" 
[matMenuTriggerFor]="valueMenu" class="valueMenuTrigger">GraphMenu
</div>