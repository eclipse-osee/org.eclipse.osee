<!--
 * Copyright (c) 2021 Boeing
 *
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 *     Boeing - initial API and implementation
 -->
<div class="mat-elevation-z8">
	<mat-form-field class="tw-w-full">
		<mat-label>Filter Configuration Information</mat-label>
		<input
			matInput
			type="text"
			(keyup)="applyFilter($event)"
			#input />
		<mat-icon matPrefix>filter_list</mat-icon>
		<mat-hint>Enter text to filter Configuration Table</mat-hint>
	</mat-form-field>
	<div
		class="tw-min-h-[72vh] tw-w-full tw-overflow-auto [&::-webkit-scrollbar-corner]:tw-bg-background-app-bar [&::-webkit-scrollbar-thumb]:tw-bg-primary [&::-webkit-scrollbar-track]:tw-border-r-[10px] [&::-webkit-scrollbar-track]:tw-bg-background-app-bar [&::-webkit-scrollbar]:tw-bg-background-app-bar">
		<table
			mat-table
			[dataSource]="(dataSource | async) || []"
			matSort
			matSortActive="feature"
			matSortDirection="asc"
			class="mat-elevation-z8 tw-w-full">
			<ng-container matColumnDef=" ">
				<th
					mat-header-cell
					*matHeaderCellDef
					colspan="1"
					class="tw-text-center tw-text-sm tw-font-bold tw-tracking-tighter tw-text-primary-600"></th>
			</ng-container>
			<ng-container matColumnDef="Configurations">
				<th
					mat-header-cell
					*matHeaderCellDef
					[attr.colspan]="viewCount | async"
					class="tw-text-center tw-text-sm tw-font-bold tw-tracking-tighter tw-text-primary-600">
					Configurations
				</th>
			</ng-container>
			<ng-container matColumnDef="Groups">
				<th
					mat-header-cell
					*matHeaderCellDef
					[attr.colspan]="(groupCount | async) || 0"
					class="tw-text-center tw-text-sm tw-font-bold tw-tracking-tighter tw-text-primary-600">
					Configuration Groups
				</th>
			</ng-container>
			<ng-container
				[matColumnDef]="secondaryHeader"
				*ngFor="
					let secondaryHeader of secondaryHeaders | async;
					let i = index;
					trackBy: valueTracker
				">
				<th
					mat-header-cell
					*matHeaderCellDef
					[attr.colspan]="(secondaryHeaderLength | async)![i]"
					[ngClass]="
						(isACfgGroup(secondaryHeader.trim()) | async)
							? (isAddedCfgGroup(secondaryHeader.trim())
									| async) === true
								? 'config-group-header applic-table-column-added'
								: (isDeletedCfgGroup(secondaryHeader.trim())
											| async) === true
								  ? 'config-group-header applic-table-column-deleted'
								  : (hasChangesCfgGroup(secondaryHeader.trim())
												| async) === true
								    ? 'config-group-header applic-table-column-changed'
								    : 'config-group-header'
							: (isDeletedCfg(secondaryHeader.trim()) | async) ===
							    true
							  ? 'applic-table-column-deleted config-header'
							  : (isAddedCfg(secondaryHeader.trim()) | async) ===
							      true
							    ? 'applic-table-column-added config-header'
							    : (hasChangesCfg(secondaryHeader.trim())
												| async) === true
							      ? 'config-header applic-table-column-changed'
							      : 'config-header'
					">
					<div class="config-group-header">
						{{ secondaryHeader }}
					</div>
				</th>
			</ng-container>
			<ng-container
				[matColumnDef]="displayedColumn.columnId"
				*ngFor="
					let displayedColumn of headers | async;
					let i = index;
					trackBy: valueTracker
				"
				[sticky]="isSticky(displayedColumn.name)">
				<th
					mat-header-cell
					*matHeaderCellDef
					[ngClass]="
						displayedColumn.name !== 'feature' &&
						displayedColumn.name !== 'values' &&
						(_editable | async) === 'true'
							? (isACfgGroup(displayedColumn.name) | async)
								? (isAddedCfgGroup(displayedColumn.name.trim())
										| async) === true
									? 'config-group-header applic-table-column-added'
									: (isDeletedCfgGroup(
												displayedColumn.name.trim()
									    ) | async) === true
									  ? 'config-group-header applic-table-column-deleted'
									  : (hasChangesCfgGroup(
													displayedColumn.name.trim()
									      ) | async) === true
									    ? 'config-group-header applic-table-column-changed'
									    : 'config-group-header'
								: (isDeletedCfg(displayedColumn.name.trim())
											| async) === true
								  ? 'applic-table-column-deleted config-header'
								  : (isAddedCfg(displayedColumn.name.trim())
												| async) === true
								    ? 'applic-table-column-added config-header'
								    : (hasChangesCfg(
													displayedColumn.name.trim()
								        ) | async) === true
								      ? 'config-header applic-table-column-changed'
								      : 'config-header'
							: ''
					">
					<div
						mat-sort-header
						[id]="displayedColumn.columnId"
						*ngIf="displayedColumn.name === 'feature'"
						start="asc"
						style="font-weight: bold">
						{{ displayedColumn.name }}
					</div>
					<ng-container
						*ngIf="{
							isCfgGroup:
								(isACfgGroup(displayedColumn.name) | async),
							editable: (_editable | async)
						} as configSettings">
						<div
							mat-header-cell
							[id]="displayedColumn.columnId"
							*ngIf="
								displayedColumn.name !== 'feature' &&
								displayedColumn.name !== 'values' &&
								configSettings.editable as _editable_
							"
							[ngClass]="
								(isACfgGroup(displayedColumn.name) | async)
									? 'config-group-header'
									: (isDeletedCfg(displayedColumn.name.trim())
												| async) === true
									  ? 'applic-table-column-deleted config-header'
									  : (isAddedCfg(displayedColumn.name.trim())
													| async) === true
									    ? 'applic-table-column-added config-header'
									    : 'config-header'
							"
							(click)="
								openConfigMenu(displayedColumn.name, _editable_)
							"
							(contextmenu)="
								openContextMenu(
									$event,
									configSettings.isCfgGroup
										? 'GROUP'
										: 'CONFIG',
									displayedColumn.name.trim()
								)
							"
							[attr.data-cy]="
								(isACfgGroup(displayedColumn.name) | async)
									? 'config-group-header-' +
									  displayedColumn.name
									: 'config-header-' + displayedColumn.name
							">
							{{ displayedColumn.name }}
						</div>
					</ng-container>
					<div
						mat-header-cell
						[id]="displayedColumn.columnId"
						*ngIf="displayedColumn.name === 'values'"></div>
				</th>
				<div
					*ngIf="
						displayedColumn.name === 'valueType' ||
						displayedColumn.name === 'productApplicabilities' ||
						displayedColumn.name === 'defaultValue' ||
						displayedColumn.name === 'multiValued'
					">
					<td
						mat-cell
						*matCellDef="let element">
						{{ element[displayedColumn.name] }}
					</td>
				</div>
				<div *ngIf="displayedColumn.name === 'feature'">
					<td
						mat-cell
						class="border-right feature-cell"
						*matCellDef="let element; index as r"
						[matTooltip]="element['description']"
						(click)="displayFeatureMenu(element)"
						[ngClass]="
							r % 2 === 0
								? element.added
									? 'applic-table-row-even-added'
									: element.deleted
									  ? 'applic-table-row-even-deleted'
									  : element.changes !== undefined
									    ? 'applic-table-row-even-changed'
									    : 'applic-table-row-even'
								: element.added
								  ? 'applic-table-row-odd-added'
								  : element.deleted
								    ? 'applic-table-row-odd-deleted'
								    : element.changes !== undefined
								      ? 'applic-table-row-odd-changed'
								      : 'applic-table-row-odd'
						"
						(contextmenu)="
							openContextMenu($event, 'FEATURE', element)
						"
						[attr.data-cy]="'feature-' + element['name']">
						<ng-container *ngIf="isCompoundApplic(element['name'])">
							<ng-container
								*ngFor="
									let name of getCompoundApplicLines(
										element['name']
									)
								">
								{{ name }}
								<br />
							</ng-container>
						</ng-container>
						<ng-container
							*ngIf="!isCompoundApplic(element['name'])">
							{{ element['name'] }}
						</ng-container>
					</td>
				</div>
				<div
					*ngIf="
						displayedColumn.name !== 'feature' &&
						displayedColumn.name !== 'description' &&
						displayedColumn.name !== 'values' &&
						displayedColumn.name !== 'valueType' &&
						displayedColumn.name !== 'productApplicabilities' &&
						displayedColumn.name !== 'defaultValue' &&
						displayedColumn.name !== 'multiValued'
					">
					<td
						mat-cell
						class="border-right"
						*matCellDef="let element; index as r"
						[ngClass]="
							r % 2 === 0
								? element.added
									? 'applic-table-row-even-added'
									: element.deleted
									  ? 'applic-table-row-even-deleted'
									  : 'applic-table-row-even'
								: element.added
								  ? 'applic-table-row-odd-added'
								  : element.deleted
								    ? 'applic-table-row-odd-deleted'
								    : 'applic-table-row-odd'
						">
						<ng-container
							*ngFor="
								let config of getUniqueConfigurations(
									element.configurations
								)
							">
							<ng-container
								*ngIf="
									isCorrectConfiguration(
										config,
										displayedColumn.name
									)
								">
								<div
									*ngIf="
										(_editable | async) === 'false' ||
											(isACfgGroup(config.name)
												| async) ||
											(isDeletedCfg(config.name)
												| async) === true ||
											(isDeletedCfgGroup(config.name)
												| async) === true ||
											isCompoundApplic(element.name);
										else edit_content
									"
									[ngClass]="
										(_editable | async) === 'true'
											? (isAddedCfg(config.name)
													| async) === true ||
											  ((isAddedCfgGroup(config.name)
													| async) === true &&
													!element.deleted)
												? 'selectApplicabilityTableOption applic-table-column-added'
												: (isDeletedCfg(config.name)
															| async) === true ||
												    (isDeletedCfgGroup(
															config.name
												    ) | async) === true
												  ? 'selectApplicabilityTableOption applic-table-column-deleted'
												  : config.changes !== undefined
												    ? 'selectApplicabilityTableOption applicability-changed'
												    : 'selectApplicabilityTableOption'
											: (isAddedCfg(config.name)
														| async) === true
											  ? 'applic-table-column-added'
											  : (isDeletedCfg(config.name)
															| async) === true
											    ? 'applic-table-column-deleted'
											    : config.changes !== undefined
											      ? 'applicability-changed selectApplicabilityTableOption'
											      : 'selectApplicabilityTableOption'
									"
									(contextmenu)="
										openContextMenu($event, 'VALUE', config)
									"
									[attr.data-cy]="
										'value-' +
										sortMultiValue(config.values) +
										'-' +
										displayedColumn.name +
										'-' +
										element.name
									">
									<mat-label>{{ config.value }}</mat-label>
								</div>
								<ng-template #edit_content>
									<ng-container
										*ngIf="element.values.length !== 0">
										<ng-container
											*ngIf="
												element.multiValued;
												else editProduct
											">
											<div
												[ngClass]="
													(isAddedCfg(config.name)
														| async) === true &&
													!element.deleted
														? r % 2 === 0
															? 'applicabilityTableMatSelect MatSelectConfig applic-table-column-added-row-even'
															: 'applicabilityTableMatSelect MatSelectConfig applic-table-column-added-row-odd'
														: config.changes !==
														    undefined
														  ? 'applicabilityTableMatSelect MatSelectConfig applicability-changed'
														  : 'applicabilityTableMatSelect MatSelectConfig'
												"
												(contextmenu)="
													openContextMenu(
														$event,
														'VALUE',
														config
													)
												">
												<mat-form-field
													[ngClass]="
														(isAddedCfg(config.name)
															| async) === true &&
														!element.deleted
															? r % 2 === 0
																? 'selectApplicabilityTableOption applic-table-column-added-row-even'
																: 'selectApplicabilityTableOption applic-table-column-added-row-odd'
															: (isDeletedCfg(
																		config.name
															    ) | async) ===
															    true
															  ? 'selectApplicabilityTableOption applic-table-column-deleted'
															  : config.changes
															    ? 'selectApplicabilityTableOption applicability-changed'
															    : 'selectApplicabilityTableOption'
													"
													id="selectableTableOption"
													class="full-width">
													<mat-select
														[(ngModel)]="
															config.values
														"
														(selectionChange)="
															modifyConfiguration(
																displayedColumn.name,
																element,
																$event
															)
														"
														multiple
														[attr.data-cy]="
															'value-' +
															sortMultiValue(
																config.values
															) +
															'-' +
															displayedColumn.name +
															'-' +
															element.name
														">
														<ng-container
															*ngFor="
																let value of element.values
															">
															<ng-container
																*ngIf="{
																	result:
																		applicIsNotPermitted(
																			displayedColumn.name,
																			element,
																			value
																		)
																		| async
																} as isNotPermitted">
																<mat-option
																	[value]="
																		value
																	"
																	[attr.data-cy]="
																		'option-' +
																		value +
																		'-' +
																		config.values.includes(
																			value
																		)
																	"
																	[disabled]="
																		isNotPermitted.result
																	">
																	<ng-container
																		*ngIf="
																			isNotPermitted.result;
																			else isPermitted
																		">
																		<del>{{
																			value
																		}}</del>
																	</ng-container>
																	<ng-template
																		#isPermitted>
																		{{
																			value
																		}}
																	</ng-template>
																</mat-option>
															</ng-container>
														</ng-container>
													</mat-select>
												</mat-form-field>
											</div>
										</ng-container>
										<ng-template #editProduct>
											<div
												[ngClass]="
													(isAddedCfg(config.name)
														| async) === true &&
													!element.deleted
														? r % 2 === 0
															? 'applicabilityTableMatSelect MatSelectProduct applic-table-column-added-row-even'
															: 'applicabilityTableMatSelect MatSelectProduct applic-table-column-added-row-odd'
														: config.changes !==
														    undefined
														  ? 'applicabilityTableMatSelect MatSelectProduct applicability-changed'
														  : 'applicabilityTableMatSelect MatSelectProduct'
												"
												(contextmenu)="
													openContextMenu(
														$event,
														'VALUE',
														config
													)
												">
												<mat-form-field
													[ngClass]="
														(isAddedCfg(config.name)
															| async) === true &&
														!element.deleted
															? r % 2 === 0
																? 'selectApplicabilityTableOption applic-table-column-added-row-even'
																: 'selectApplicabilityTableOption applic-table-column-added-row-odd'
															: (isDeletedCfg(
																		config.name
															    ) | async) ===
															    true
															  ? 'selectApplicabilityTableOption applic-table-column-deleted'
															  : config.changes !==
															      undefined
															    ? 'selectApplicabilityTableOption applicability-changed'
															    : 'selectApplicabilityTableOption'
													"
													id="selectableTableOption"
													class="full-width">
													<mat-select
														[(ngModel)]="
															config.value
														"
														(selectionChange)="
															modifyProduct(
																displayedColumn.name,
																element,
																$event
															)
														"
														[attr.data-cy]="
															'value-' +
															config.value +
															'-' +
															displayedColumn.name +
															'-' +
															element.name
														">
														<ng-container
															*ngFor="
																let value of element.values
															">
															<ng-container
																*ngIf="{
																	result:
																		applicIsNotPermitted(
																			displayedColumn.name,
																			element,
																			value
																		)
																		| async
																} as isNotPermitted">
																<mat-option
																	[value]="
																		value
																	"
																	[attr.data-cy]="
																		'option-' +
																		value +
																		'-' +
																		config.values.includes(
																			value
																		)
																	"
																	[disabled]="
																		isNotPermitted.result
																	">
																	<ng-container
																		*ngIf="
																			isNotPermitted.result;
																			else isPermitted
																		">
																		<del>{{
																			value
																		}}</del>
																	</ng-container>
																	<ng-template
																		#isPermitted>
																		{{
																			value
																		}}
																	</ng-template>
																</mat-option>
															</ng-container>
														</ng-container>
													</mat-select>
												</mat-form-field>
											</div>
										</ng-template>
									</ng-container>
								</ng-template>
							</ng-container>
						</ng-container>
					</td>
				</div>
			</ng-container>
			<tr
				mat-header-row
				*matHeaderRowDef="topLevelHeaders | async; sticky: true"></tr>
			<tr
				mat-header-row
				*matHeaderRowDef="secondaryHeaders | async; sticky: true"></tr>
			<tr
				mat-header-row
				*matHeaderRowDef="columnIds | async; sticky: true"></tr>
			<tr
				mat-row
				*matRowDef="let row; columns: columnIds | async"
				class="config-table-row"></tr>
			<tr
				class="mat-row"
				*matNoDataRow>
				<td
					class="mat-cell"
					colspan="(viewCount|async)+(groupCount|async)+1">
					No data matching filter
				</td>
			</tr>
		</table>
	</div>
</div>
<mat-paginator [pageSizeOptions]="[10, 15, 25, 100]"></mat-paginator>
<mat-error *ngIf="(errors | async)!.length > 0">{{ errors | async }}</mat-error>
<mat-menu #featureMenu="matMenu">
	<ng-template
		matMenuContent
		let-feature="feature">
		<osee-plconfig-feature-menu
			[feature]="feature"></osee-plconfig-feature-menu>
	</ng-template>
</mat-menu>
<mat-menu #configMenu="matMenu">
	<ng-template
		matMenuContent
		let-config="config">
		<osee-plconfig-config-menu
			[config]="
				(config | async) || {
					name: '',
					description: '',
					hasFeatureApplicabilities: false,
					id: ''
				}
			"></osee-plconfig-config-menu>
	</ng-template>
</mat-menu>
<mat-menu #configGroupMenu="matMenu">
	<ng-template
		matMenuContent
		let-group="group">
		<osee-plconfig-config-group-menu
			[group]="
				(group | async) || {
					name: '',
					description: '',
					id: '',
					configurations: []
				}
			"></osee-plconfig-config-group-menu>
	</ng-template>
</mat-menu>
<mat-menu #valueMenu="matMenu">
	<ng-template
		matMenuContent
		let-value="value">
		<osee-plconfig-value-menu [value]="value"></osee-plconfig-value-menu>
	</ng-template>
</mat-menu>
<div
	#featureMenuTrigger="matMenuTrigger"
	style="visibility: hidden; position: fixed"
	[style.left]="menuPosition.x"
	[style.top]="menuPosition.y"
	[matMenuTriggerFor]="featureMenu"
	class="featureMenu">
	LinkMenu
</div>
<div
	#configMenuTrigger="matMenuTrigger"
	style="visibility: hidden; position: fixed"
	[style.left]="menuPosition.x"
	[style.top]="menuPosition.y"
	[matMenuTriggerFor]="configMenu"
	class="configMenuTrigger">
	NodeMenu
</div>
<div
	#configGroupMenuTrigger="matMenuTrigger"
	style="visibility: hidden; position: fixed"
	[style.left]="menuPosition.x"
	[style.top]="menuPosition.y"
	[matMenuTriggerFor]="configGroupMenu"
	class="configGroupMenuTrigger">
	GraphMenu
</div>
<div
	#valueMenuTrigger="matMenuTrigger"
	style="visibility: hidden; position: fixed"
	[style.left]="menuPosition.x"
	[style.top]="menuPosition.y"
	[matMenuTriggerFor]="valueMenu"
	class="valueMenuTrigger">
	GraphMenu
</div>
