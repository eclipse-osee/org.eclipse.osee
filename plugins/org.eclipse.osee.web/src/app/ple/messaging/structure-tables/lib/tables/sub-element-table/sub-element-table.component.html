<!--
 * Copyright (c) 2021 Boeing
 *
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 *     Boeing - initial API and implementation
 -->
<table
	mat-table
	[dataSource]="dataSource"
	multiTemplateDataRows
	cdkDropList
	[cdkDropListDisabled]="!editMode"
	(cdkDropListDropped)="handleDragDrop($event)"
	[trackBy]="elementTracker"
	class="mat-elevation-z8 tw-w-full tw-max-w-max"
	data-cy="sub-element-table">
	<ng-container
		[matColumnDef]="header"
		*ngFor="let header of elementHeaders">
		<th
			mat-header-cell
			*matHeaderCellDef
			class="tw-text-center tw-font-medium tw-text-primary"
			[ngClass]="{
				'tw-flex-[0_0_8%]': header === 'interfaceElementAlterable',
				'tw-flex-[0_0_10%]': header === 'platformType',
				'tw-w-1/4': header === 'platformType' && editMode,
				'tw-w-[10%]': header === 'platformType' && !editMode,
				'tw-max-w-[10%] tw-flex-[1_1_10%] tw-pr-4': header === 'name',
				'tw-flex-[3_1_content]': header === 'description'
			}"
			[matTooltip]="(getHeaderByName(header) | async)?.description || ''"
			[attr.data-cy]="'element-table-header-' + header"
			[class.edit]="editMode">
			{{ (getHeaderByName(header) | async)?.humanReadable || '' }}
		</th>
		<td
			mat-cell
			*matCellDef="let element"
			class="tw-text-center"
			[ngClass]="{
				'tw-bg-accent-100 dark:tw-text-background-app-bar dark:[&>*>*>*>*>*>*>*>*>*]:tw-text-background-app-bar dark:[&>*>*>*>*]:tw-text-background-app-bar':
					!element.added &&
					!element.deleted &&
					element.changes !== undefined &&
					element.changes[header] !== undefined,
				'tw-flex-[0_0_8%]': header === 'interfaceElementAlterable',
				'tw-flex-[0_0_10%]': header === 'platformType',
				'tw-w-1/4': header === 'platformType' && editMode,
				'tw-w-[10%]': header === 'platformType' && !editMode,
				'tw-max-w-[10%] tw-flex-[1_1_10%] tw-pr-4': header === 'name',
				'tw-flex-[3_1_content]': header === 'description'
			}"
			(contextmenu)="
				openGeneralMenu($event, element, header, element[header])
			"
			[class.edit]="editMode">
			<ng-container *ngIf="header === 'rowControls'">
				<div class="tw-flex tw-items-center tw-gap-2">
					<ng-container
						*ngIf="editMode === true && !element.autogenerated">
						<mat-icon
							cdkDrag
							cdkDragHandle
							cdkDragLockAxis="y"
							cdkDragRootElement=".sub-element-drag-row"
							>reorder</mat-icon
						>
					</ng-container>
					<ng-container *ngIf="element.interfaceElementArrayHeader">
						<ng-container
							*ngIf="{
								value: rowIsExpanded(element.id)
							} as _expanded">
							<button
								mat-icon-button
								[@expandButton]="
									!_expanded.value() ? 'closed' : 'open'
								"
								[attr.data-cy]="
									_expanded.value()
										? 'close-element-btn-' + element.id
										: 'expand-element-btn-' + element.id
								"
								(click)="rowChange(element, !_expanded.value())"
								[ngClass]="{
									'tw-bg-accent-50 dark:tw-bg-accent-600 dark:tw-text-background-app-bar':
										containsAutogenSpare(element)
								}">
								<mat-icon>expand_more</mat-icon>
							</button>
						</ng-container>
					</ng-container>
				</div>
			</ng-container>
			<ng-container *ngIf="header !== 'rowControls'">
				<osee-messaging-sub-element-table-field
					[header]="header"
					[editMode]="editMode"
					[element]="element"
					[structure]="structure"
					[filter]="filter"
					(menu)="
						openGeneralMenu(
							$event.event,
							element,
							header,
							element[header]
						)
					"></osee-messaging-sub-element-table-field>
			</ng-container>
		</td>
	</ng-container>
	<ng-container matColumnDef="expandedElement">
		<td
			mat-cell
			*matCellDef="let element"
			[attr.colspan]="elementHeaders.length">
			<ng-container *ngIf="element.interfaceElementArrayHeader">
				<div
					class="tw-flex tw-w-full tw-flex-col"
					[@detailExpand]="
						rowIsExpanded(element.id)() ? 'expanded' : 'collapsed'
					">
					<ng-container *ngIf="rowIsExpanded(element.id)()">
						<osee-sub-element-array-table
							[element]="element"
							[elementHeaders]="elementHeaders"
							[editMode]="editMode"
							class="tw-pb-2"></osee-sub-element-array-table>
					</ng-container>
				</div>
			</ng-container>
		</td>
	</ng-container>
	<tr
		mat-header-row
		*matHeaderRowDef="elementHeaders; sticky: true"></tr>
	<tr
		mat-row
		*matRowDef="let row2; columns: elementHeaders"
		[id]="'a' + row2.id"
		[attr.data-cy]="'element-table-row-' + row2.name"
		class="sub-element-drag-row tw-transition-colors tw-duration-300 tw-ease-in-out"
		[ngClass]="
			row2.added
				? 'even-multi:tw-bg-success-200 even-multi:hover:tw-bg-success-300 odd-multi:tw-bg-success-100 odd-multi:hover:tw-bg-success-200 even-multi:dark:tw-bg-success-700 even-multi:dark:hover:tw-bg-success-800 odd-multi:dark:tw-bg-success-600 odd-multi:dark:hover:tw-bg-success-700'
				: row2.deleted
				  ? 'even-multi:tw-bg-warning-400 even-multi:hover:tw-bg-warning-300 odd-multi:tw-bg-warning-300 odd-multi:hover:tw-bg-warning-200 even-multi:dark:tw-bg-warning-800 even-multi:dark:hover:tw-bg-warning-700 odd-multi:dark:tw-bg-warning-400 odd-multi:dark:hover:tw-bg-warning-300 even-multi:[&>*]:tw-text-foreground-text odd-multi:[&>*]:tw-text-foreground-text even-multi:dark:[&>*]:tw-text-background-app-bar odd-multi:dark:[&>*]:tw-text-background-app-bar odd-multi:[&>td>*>*>*]:tw-text-foreground-text odd-multi:dark:[&>td>*>*>*]:tw-text-background-app-bar'
				  : row2.autogenerated
				    ? 'even-multi:tw-bg-accent-50 even-multi:hover:tw-bg-accent-100 odd-multi:tw-bg-accent-100 odd-multi:hover:tw-bg-accent-200 even-multi:dark:tw-bg-accent-600 even-multi:dark:hover:tw-bg-accent-500 odd-multi:dark:tw-bg-accent-700 odd-multi:dark:tw-bg-opacity-30 odd-multi:dark:hover:tw-bg-accent-600 even-multi:dark:[&>*]:tw-text-background-app-bar odd-multi:dark:[&>*]:tw-text-background-app-bar odd-multi:dark:[&>td>*>*>*]:tw-text-background-app-bar'
				    : 'even-multi:tw-bg-primary-100 even-multi:hover:tw-bg-primary-200 odd-multi:tw-bg-primary-200 odd-multi:hover:tw-bg-primary-300 even-multi:dark:tw-bg-primary-600 even-multi:dark:hover:tw-bg-primary-500 odd-multi:dark:tw-bg-primary-700 odd-multi:dark:hover:tw-bg-primary-600'
		"></tr>
	<tr
		mat-row
		*matRowDef="let row; columns: ['expandedElement']"
		[ngClass]="row.arrayElements.length === 0 ? 'tw-hidden' : ''"
		class="tw-h-0 tw-flex-nowrap"></tr>
</table>
<mat-menu #generalMenu="matMenu">
	<ng-template
		matMenuContent
		let-element="element"
		let-structure="structure"
		let-field="field"
		let-header="header">
		<osee-sub-element-table-dropdown
			[element]="element"
			[structure]="structure"
			[header]="header"
			[branchId]="_branchId"
			[branchType]="_branchType"
			[field]="field"
			[editMode]="editMode"></osee-sub-element-table-dropdown>
	</ng-template>
</mat-menu>
<div
	#generalMenuTrigger="matMenuTrigger"
	style="visibility: hidden; position: fixed"
	[style.left]="menuPosition.x"
	[style.top]="menuPosition.y"
	[matMenuTriggerFor]="generalMenu"></div>
