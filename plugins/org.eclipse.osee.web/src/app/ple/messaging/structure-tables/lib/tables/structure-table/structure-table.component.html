<!--
 * Copyright (c) 2021 Boeing
 *
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 *     Boeing - initial API and implementation
 -->
<ng-container
	class="hidden"
	*ngIf="_messageData | async"></ng-container>
<osee-messaging-controls
	[branchControls]="false"
	[actionControls]="true"
	[diff]="true"
	[diffRouteLink]="
		(inDiffMode | async) === 'false'
			? [
					{
						outlets: {
							primary: 'diff',
							rightSideNav: null
						}
					}
			  ]
			: structureId !== ''
			? '../'
			: '../'
	">
	<osee-view-selector></osee-view-selector>
</osee-messaging-controls>
<ng-container>
	<ng-container *ngIf="((isEditing | async) || false) === true">
		<osee-two-layer-add-button
			class="new-structure-button"
			[firstOptionDisabled]="structureId !== ''"
			[nestedLevel]="(expandedElement | async) || []"
			baseLevel="Add structure"
			nestedLevelPrefix="Add element to "
			(normalClick)="openAddStructureDialog()"
			(nestedClick)="openAddElementDialog($event)"
			nestedIcon="description"
			baseIcon="assignment"></osee-two-layer-add-button>
	</ng-container>
</ng-container>
<ng-container *ngIf="inDiffMode | async as _diff">
	<div
		class="message-element-interface message-element-interface-top-level-table"
		#topOfTable>
		<ng-container *ngIf="currentStructureHeaders | async as currentHeaders">
			<ng-container *ngIf="hasFilter">
				<mat-form-field
					class="message-element-interface-table-view-width-100 message-element-interface-table-filter-padding">
					<mat-label>Filter Message Information</mat-label>
					<input
						matInput
						type="text"
						(keyup)="applyFilter($event)"
						#input />
					<mat-icon matPrefix>filter_list</mat-icon>
					<mat-hint
						>Enter text to filter Structure Table. Only full text
						matches will show results.
					</mat-hint>
				</mat-form-field>
			</ng-container>
			<table
				mat-table
				[dataSource]="messageData || []"
				multiTemplateDataRows
				class="mat-elevation-z7">
				<ng-container matColumnDef="Breadcrumbs">
					<th
						mat-header-cell
						*matHeaderCellDef
						[attr.colspan]="currentHeaders.length"
						class="message-element-interface-table-view-message-header message-element-interface-breadcrumbs"
						[routerLink]="previousLink">
						{{ breadCrumb }}
					</th>
				</ng-container>
				<ng-container
					[matColumnDef]="header.toString()"
					*ngFor="
						let header of currentHeaders;
						let i = index;
						trackBy: valueTracker
					">
					<th
						mat-header-cell
						*matHeaderCellDef
						[attr.colspan]="currentHeaders[i]"
						class="message-element-interface-table-view-message-header"
						[matTooltip]="
							(getHeaderByName(header) | async)?.description || ''
						"
						[attr.data-cy]="'structure-table-header-' + header">
						<ng-container>
							{{
								(getHeaderByName(header) | async)
									?.humanReadable || ''
							}}
						</ng-container>
					</th>
					<td
						mat-cell
						*matCellDef="let element; let i = dataIndex"
						[ngClass]="
							i % 2 === 0
								? element.added
									? 'message-table-row-even-added'
									: element.deleted
									? 'message-table-row-even-deleted'
									: element.changes !== undefined &&
									  element.changes[header] !== undefined
									? 'message-table-row-changed'
									: element.autogenerated
									? 'tw-bg-accent-100 dark:tw-bg-accent-700'
									: 'message-table-row-even'
								: element.added
								? 'message-table-row-odd-added'
								: element.deleted
								? 'message-table-row-odd-deleted'
								: element.changes !== undefined &&
								  element.changes[header] !== undefined
								? 'message-table-row-changed'
								: element.autogenerated
								? 'tw-bg-accent-50 dark:tw-bg-accent-600'
								: 'message-table-row-odd'
						"
						[ngStyle]="{
							width: (layout | async)?.tableRecommendations?.width
						}"
						(contextmenu)="
							openMenu(
								$event,
								element.id,
								element.name,
								element.description,
								element,
								header,
								_diff
							)
						"
						class="message-structure-attribute-cell">
						<div class="flex-row">
							<ng-container
								*ngIf="
									!!(isEditing | async) === true &&
										!element.autogenerated;
									else no_edit
								">
								<ng-container *ngIf="header === ' '">
									<ng-container
										*ngIf="{
											value:
												(rowIsExpanded(element.id)
												| async)
										} as _expanded">
										<button
											mat-icon-button
											[@expandButton]="
												!_expanded.value
													? 'closed'
													: 'open'
											"
											[attr.data-cy]="
												_expanded.value
													? 'close-structure-btn-' +
													  element.name
													: 'expand-structure-btn-' +
													  element.name
											"
											(click)="
												rowChange(
													element,
													!_expanded.value
												)
											"
											[ngClass]="
												element.hasElementChanges
													? 'message-table-attribute-changed'
													: 'message-table-attribute-not-changed'
											">
											<mat-icon>expand_more</mat-icon>
										</button>
									</ng-container>
								</ng-container>
								<ng-container
									*ngIf="
										editableStructureHeaders.includes(
											header
										);
										else no_edit
									">
									<osee-messaging-edit-structure-field
										[structureId]="element['id']"
										[header]="header"
										[value]="element[header]"
										[attr.data-cy]="
											'structure-table-' +
											header +
											'-' +
											element.name +
											'-' +
											element[header]
										"></osee-messaging-edit-structure-field>
								</ng-container>
							</ng-container>
							<ng-template #no_edit>
								<ng-container
									*ngIf="
										header === ' ' &&
										(!!(isEditing | async) === false ||
											element.autogenerated)
									">
									<!--Don't know why 1 element in a template has decided to render in a non-rendered template-->
									<ng-container
										*ngIf="{
											value:
												(rowIsExpanded(element.id)
												| async)
										} as _expanded">
										<button
											mat-icon-button
											[@expandButton]="
												!_expanded.value
													? 'closed'
													: 'open'
											"
											(click)="
												rowChange(
													element,
													!_expanded.value
												)
											"
											[ngClass]="
												element.hasElementChanges
													? 'message-table-attribute-changed'
													: 'message-table-attribute-not-changed'
											">
											<mat-icon>expand_more</mat-icon>
										</button>
									</ng-container>
								</ng-container>
								<ng-container
									*ngIf="header === 'applicability'">
									<ng-container
										*ngIf="element[header].name !== 'Base'">
										{{ element[header].name }}
									</ng-container>
								</ng-container>
								<ng-container *ngIf="header === 'sizeInBytes'">
									<div
										[ngClass]="
											element.incorrectlySized === true
												? 'attribute-wrong'
												: ''
										"
										oseeHighlightFilteredText
										[searchTerms]="searchTerms"
										[text]="element[header]"
										classToApply="message-element-interface-table-highlighted-text"
										[attr.data-cy]="
											'structure-table-' +
											header +
											'-' +
											element.name +
											'-' +
											element[header]
										">
										{{ element[header] }}
									</div>
								</ng-container>
								<ng-container
									*ngIf="
										header === 'name' ||
										header === 'description'
									">
									<osee-structure-table-long-text-field
										[text]="element[header]"
										[searchTerms]="searchTerms"
										[width]="
											(layout | async)
												?.tableRecommendations?.width
										"
										[data_cy]="
											'structure-table-' +
											header +
											'-' +
											element.name +
											'-' +
											element[header]
										"></osee-structure-table-long-text-field>
								</ng-container>
								<ng-container
									*ngIf="
										header === 'txRate' ||
										header === 'publisher' ||
										header === 'messageNumber'
									">
									<ng-container
										*ngIf="
											_messageData | async as messageData
										">
										<ng-container [ngSwitch]="header">
											<ng-container
												*ngSwitchCase="'txRate'">
												{{
													messageData.interfaceMessageRate
												}}
											</ng-container>
											<ng-container
												*ngSwitchCase="'publisher'">
												<ng-container
													*ngFor="
														let node of messageData.publisherNodes
													">
													{{ node.name }}
												</ng-container>
											</ng-container>
											<ng-container
												*ngSwitchCase="'messageNumber'">
												{{
													messageData.interfaceMessageNumber
												}}
											</ng-container>
										</ng-container>
									</ng-container>
								</ng-container>
								<div
									*ngIf="
										header !== 'applicability' &&
										header !== ' ' &&
										header !== 'name' &&
										header !== 'description' &&
										header !== 'sizeInBytes' &&
										header !== 'txRate' &&
										header !== 'publisher' &&
										header !== 'messageNumber'
									"
									oseeHighlightFilteredText
									[searchTerms]="searchTerms"
									[text]="element[header]"
									classToApply="message-element-interface-table-highlighted-text"
									[attr.data-cy]="
										'structure-table-' +
										header +
										'-' +
										element.name +
										'-' +
										element[header]
									">
									{{ element[header] }}
								</div>
							</ng-template>
						</div>
					</td>
				</ng-container>
				<ng-container matColumnDef="expandedMessage">
					<td
						mat-cell
						*matCellDef="let structure"
						[attr.colspan]="currentHeaders.length"
						class="no-pad">
						<div
							class="sub-message-detail message-element-interface-table-view-width-100"
							[@detailExpand]="
								(rowIsExpanded(structure.id) | async) || false
									? 'expanded'
									: 'collapsed'
							">
							<ng-container
								*ngIf="
									(rowIsExpanded(structure.id) | async) ||
									false
								">
								<osee-messaging-message-element-interface-sub-element-table
									[data]="structure.elements"
									[filter]="filter"
									[structure]="structure"
									(expandRow)="expandRow($event)"
									[subMessageHeaders]="
										(currentElementHeaders | async) || []
									"
									[editMode]="
										(isEditing | async) || false
									"></osee-messaging-message-element-interface-sub-element-table>
							</ng-container>
						</div>
					</td>
				</ng-container>
				<tr
					mat-header-row
					*matHeaderRowDef="['Breadcrumbs']; sticky: true"></tr>
				<tr
					mat-header-row
					*matHeaderRowDef="currentHeaders; sticky: true"></tr>
				<tr
					mat-row
					*matRowDef="let row; columns: currentHeaders; let k = index"
					class="message-detail-row"
					[class.message-expanded-detail-row]="
						(rowIsExpanded(row.id) | async) || false
					"
					[class.message-element-structure-added-even]="
						row.added && k % 2 === 0
					"
					[class.message-element-structure-added-odd]="
						row.added && k % 2 === 1
					"
					[class.message-element-structure-deleted]="
						row.deleted
					"></tr>
				<tr
					mat-row
					*matRowDef="let row; columns: ['expandedMessage']"
					class="message-expanded-detail-row"></tr>
			</table>
			<ng-container *ngIf="structures | async as st">
				<ng-container *ngIf="hasFilter">
					<mat-paginator
						[pageSizeOptions]="[10, 15, 20, 25, 50, 75, 100]"
						[pageIndex]="currentPage | async"
						(page)="setPage($event)"
						[length]="structuresCount | async"
						[disabled]="false"></mat-paginator>
				</ng-container>
			</ng-container>
		</ng-container>
	</div>
</ng-container>
<mat-menu #contextMenu="matMenu">
	<ng-template
		matMenuContent
		let-id="id"
		let-name="name"
		let-description="description"
		let-structure="structure"
		let-header="header"
		let-diffMode="diffMode"
		let-url="url">
		<ng-container *ngIf="inDiffMode | async as _diff">
			<a
				mat-menu-item
				target="_blank"
				*ngIf="hasFilter"
				[routerLink]="url"
				><mat-icon color="primary">open_in_new</mat-icon>Open structure
				table in new tab</a
			>
		</ng-container>
		<ng-container *ngIf="!structure.autogenerated">
			<button
				mat-menu-item
				(click)="openDescriptionDialog(description, id)"
				data-cy="structure-open-description-btn">
				<mat-icon color="primary">description</mat-icon>Open Description
			</button>
		</ng-container>
		<ng-container
			*ngIf="
				(getHeaderByName(header) | async)?.humanReadable ||
				'' as headername
			">
			<ng-container
				*ngIf="
					structure.changes !== undefined &&
					structure.changes[header] !== undefined &&
					structure.changes[header] !== true &&
					structure.changes[header] !== false
				">
				<button
					mat-menu-item
					(click)="
						viewDiff(true, structure.changes[header], headername)
					"
					data-cy="structure-diff-btn">
					<mat-icon color="accent">pageview</mat-icon>View Diff
				</button>
			</ng-container>
		</ng-container>
		<ng-container
			*ngIf="(isEditing | async) === true && !structure.deleted">
			<ng-container *ngIf="!structure.autogenerated">
				<button
					mat-menu-item
					(click)="removeStructureDialog(id, name)"
					data-cy="structure-remove-btn">
					<mat-icon color="warn">remove_circle_outline</mat-icon
					>Remove structure from submessage
				</button>
				<button
					mat-menu-item
					(click)="deleteStructureDialog(id, name)"
					data-cy="structure-delete-btn">
					<mat-icon color="warn">delete_forever</mat-icon>Delete
					structure globally
				</button>
				<button
					mat-menu-item
					(click)="insertStructure(id)"
					data-cy="structure-insert-after-btn">
					<mat-icon color="success">add</mat-icon>Insert structure
					after
				</button>
				<button
					mat-menu-item
					(click)="insertStructure('start')"
					data-cy="structure-insert-top-btn">
					<mat-icon color="success">add</mat-icon>Insert structure at
					start
				</button>
				<button
					mat-menu-item
					(click)="insertStructure()"
					data-cy="structure-insert-end-btn">
					<mat-icon color="success">add</mat-icon>Insert structure at
					end
				</button>
			</ng-container>
			<ng-container *ngIf="structure.autogenerated">
				<mat-label>
					No options available for autogenerated structures.
				</mat-label>
			</ng-container>
		</ng-container>
	</ng-template>
</mat-menu>
<div
	style="visibility: hidden; position: fixed"
	[style.left]="menuPosition.x"
	[style.top]="menuPosition.y"
	[matMenuTriggerFor]="contextMenu"></div>
