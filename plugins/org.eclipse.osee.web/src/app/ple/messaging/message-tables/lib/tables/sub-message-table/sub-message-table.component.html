<!--
 * Copyright (c) 2021 Boeing
 *
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 *     Boeing - initial API and implementation
 -->
<div class="message-interface-table-view mat-elevation-z9">
	<table
		mat-table
		[dataSource]="dataSource"
		class="tw-w-full">
		<ng-container
			[matColumnDef]="header"
			*ngFor="
				let header of (headers | async) || [];
				let j = index;
				trackBy: valueTracker
			">
			<th
				mat-header-cell
				*matHeaderCellDef
				class="tw-px-[2px] tw-py-0 tw-text-center tw-text-sm tw-font-medium tw-text-primary"
				[matTooltip]="
					(getHeaderByName(header) | async)?.description || ''
				">
				{{ (getHeaderByName(header) | async)?.humanReadable || '' }}
			</th>
			<td
				mat-cell
				*matCellDef="let value"
				class="tw-px-[2px] tw-py-0 tw-text-center"
				[attr.data-cy]="'sub-msg-field-' + header + '-' + value[header]"
				(contextmenu)="
					openMenu(
						$event,
						element,
						value,
						element.name + ' > ' + value.name,
						value[header],
						header
					)
				"
				[ngClass]="
					!value.added &&
					!value.deleted &&
					value.changes &&
					value.changes[header] !== undefined
						? 'tw-bg-accent-100 dark:tw-text-background-app-bar'
						: ''
				">
				<ng-container
					*ngIf="
						editMode === false ||
							value.deleted ||
							value.autogenerated;
						else edit_Mode
					">
					<ng-container *ngIf="header === 'description'">
						<ng-container
							*ngIf="
								value[header] !== null &&
								value[header] !== undefined &&
								value[header].length !== undefined
							">
							<div
								oseeHighlightFilteredText
								[searchTerms]="filter"
								[text]="
									value[header]
										| displayTruncatedStringWithFieldOverflow
											: 75
								"
								classToApply="message-interface-table-highlighted-text">
								{{
									value[header]
										| displayTruncatedStringWithFieldOverflow
											: 75
								}}
							</div>
						</ng-container>
					</ng-container>
					<ng-container
						*ngIf="
							header !== 'description' &&
							header !== ' ' &&
							header !== 'applicability'
						">
						<div
							oseeHighlightFilteredText
							[searchTerms]="filter"
							[text]="value[header]"
							classToApply="message-interface-table-highlighted-text">
							{{ value[header] }}
						</div>
					</ng-container>
					<ng-container *ngIf="header === ' '"
						><a
							mat-raised-button
							[routerLink]="
								element.id +
								'/' +
								value['id'] +
								'/' +
								'elements'
							"
							>Go To Message Details</a
						>
					</ng-container>
					<ng-container *ngIf="header === 'applicability'">
						<ng-container
							*ngIf="
								value[header] !== undefined &&
								value[header] !== null
							">
							<ng-container *ngIf="value[header].name !== 'Base'">
								<div
									oseeHighlightFilteredText
									[searchTerms]="filter"
									[text]="value[header].name"
									classToApply="message-interface-table-highlighted-text"
									[attr.data-cy]="
										'submessage-table-' +
										header +
										'-' +
										value.name +
										'-' +
										value[header]
									">
									{{ value[header] }}
								</div>
							</ng-container>
						</ng-container>
					</ng-container>
				</ng-container>
				<ng-template #edit_Mode>
					<ng-container *ngIf="header !== ' '">
						<osee-messaging-edit-sub-message-field
							[messageId]="element.id"
							[subMessageId]="value['id']"
							[header]="header"
							[value]="value[header]"
							[attr.data-cy]="
								'submessage-table-' +
								header +
								'-' +
								value.name +
								'-' +
								value[header]
							"></osee-messaging-edit-sub-message-field>
					</ng-container>
					<ng-container
						*ngIf="
							header === ' ' && (_messageRoute | async) as mRoute
						">
						<a
							mat-raised-button
							[routerLink]="
								mRoute.beginning +
								element.id +
								'/' +
								value['id'] +
								'/' +
								'elements' +
								mRoute.end
							"
							>Go To Message Details</a
						>
					</ng-container>
				</ng-template>
			</td>
		</ng-container>
		<tr
			mat-header-row
			*matHeaderRowDef="(headers | async) || []"></tr>
		<tr
			mat-row
			*matRowDef="
				let row2;
				columns: (headers | async) || [];
				let k = index
			"
			[id]="'a' + row2.id"
			[ngClass]="
				row2.added
					? 'odd:tw-bg-success-200 even:tw-bg-success-100 even:tw-text-foreground-text odd:dark:tw-bg-success-800 even:dark:tw-bg-success-600 even:dark:tw-text-background'
					: row2.deleted
					? 'odd:tw-bg-warning-200 even:tw-bg-warning-100'
					: row2.autogenerated
					? 'odd:tw-bg-accent-50 even:tw-bg-accent-100 odd:dark:tw-bg-accent-600 even:dark:tw-bg-accent-700'
					: 'odd:tw-bg-primary-200 even:tw-bg-primary-100 odd:dark:tw-bg-primary-700 even:dark:tw-bg-primary-600'
			"
			[attr.data-cy]="'sub-message-table-row-' + row2.name"></tr>
	</table>
</div>
<mat-menu #contextMenu="matMenu">
	<ng-template
		matMenuContent
		let-message="message"
		let-submessage="submessage"
		let-location="location"
		let-field="field"
		let-header="header"
		let-change="change">
		<ng-container *ngIf="_messageRoute | async as mRoute">
			<a
				mat-menu-item
				[routerLink]="
					mRoute.beginning +
					message.id +
					'/' +
					submessage.id +
					'/' +
					'elements' +
					mRoute.end
				"
				data-cy="sub-msg-details-nav-btn"
				><mat-icon>subdirectory_arrow_right</mat-icon>Open submessage
				details</a
			>
			<a
				mat-menu-item
				target="_blank"
				[routerLink]="
					mRoute.beginning +
					message.id +
					'/' +
					submessage.id +
					'/' +
					'elements' +
					mRoute.end
				"
				data-cy="sub-msg-details-nav-new-tab-btn"
				><mat-icon color="primary">open_in_new</mat-icon>Open submessage
				details in new tab</a
			>
		</ng-container>
		<ng-container *ngIf="!submessage.autogenerated">
			<button
				mat-menu-item
				(click)="
					openDescriptionDialog(
						submessage.description,
						submessage.id,
						message.id
					)
				"
				data-cy="sub-msg-open-description-btn">
				<mat-icon color="primary">description</mat-icon>Open Description
			</button>
		</ng-container>
		<ng-container *ngIf="isDifference(change)">
			<button
				mat-menu-item
				(click)="viewDiff(true, change, header)">
				<mat-icon
					color="accent"
					data-cy="sub-msg-diff-btn"
					>pageview</mat-icon
				>View Diff
			</button>
		</ng-container>
		<ng-container *ngIf="editMode === true">
			<ng-container *ngIf="!submessage.autogenerated">
				<button
					mat-menu-item
					(click)="removeSubMessage(submessage, message)">
					<mat-icon
						color="warn"
						data-cy="sub-msg-remove-btn"
						>remove_circle_outline</mat-icon
					>Remove submsg from message
				</button>
				<button
					mat-menu-item
					(click)="deleteSubMessage(submessage)">
					<mat-icon
						color="warn"
						data-cy="sub-msg-delete-btn"
						>delete_forever</mat-icon
					>Delete submsg globally
				</button>
				<button
					mat-menu-item
					(click)="insertSubMessage(message, submessage.id)"
					data-cy="sub-msg-insert-after-btn">
					<mat-icon color="success">add</mat-icon>Insert submsg after
				</button>
				<button
					mat-menu-item
					(click)="insertSubMessage(message, 'start')"
					data-cy="sub-msg-insert-top-btn">
					<mat-icon color="success">add</mat-icon>Insert submsg at top
				</button>
				<button
					mat-menu-item
					(click)="insertSubMessage(message)"
					data-cy="sub-msg-insert-end-btn">
					<mat-icon color="success">add</mat-icon>Insert submsg at end
				</button>
			</ng-container>
			<ng-container *ngIf="submessage.autogenerated">
				<mat-label>
					No options available for autogenerated submessages.
				</mat-label>
			</ng-container>
		</ng-container>
	</ng-template>
</mat-menu>
<div
	style="visibility: hidden; position: fixed"
	[style.left]="menuPosition.x"
	[style.top]="menuPosition.y"
	[matMenuTriggerFor]="contextMenu"></div>
