<!--
 * Copyright (c) 2021 Boeing
 *
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 *     Boeing - initial API and implementation
 -->
<div class="message-interface-table-view mat-elevation-z9">
    <table mat-table [dataSource]="dataSource" class="message-interface-table-view-width-100">
        <ng-container [matColumnDef]="header" *ngFor="let header of (headers|async)||[];let j=index;trackBy:valueTracker">
         <th mat-header-cell *matHeaderCellDef class="message-interface-table-view-sub-message-header" [matTooltip]="(getHeaderByName(header)|async)?.description||''">{{(getHeaderByName(header)|async)?.humanReadable||''}}</th>
         <td mat-cell *matCellDef="let value" class="message-interface-table-center" [attr.data-cy]="'sub-msg-field-'+header+'-'+value[header]" (contextmenu)="openMenu($event,element,value,element.name+' > '+value.name,value[header],header)" [ngClass]="!value.added && !value.deleted && value.changes && value.changes[header] !==undefined?'message-table-attribute-changed':'message-table-attribute-not-changed'">
            <ng-container *ngIf="editMode==false || value.deleted || value.autogenerated; else edit_Mode;">
                <ng-container *ngIf="header==='description'">
                    <div appHighlightFilteredText [searchTerms]="filter" [text]="value[header] | displayTruncatedStringWithFieldOverflow:75" classToApply="ple-message-interface-table-highlighted-text">
                        {{value[header] | displayTruncatedStringWithFieldOverflow:75}}
                    </div>
                </ng-container>
                <ng-container *ngIf="header!=='description' && header!==' ' && header!=='applicability'">
                    <div appHighlightFilteredText [searchTerms]="filter" [text]="value[header]" classToApply="ple-message-interface-table-highlighted-text">
                        {{value[header]}}
                    </div>
                </ng-container>
                <ng-container *ngIf="header===' '"><a mat-raised-button [routerLink]="element.id+'/'+value['id']+'/'+element.name+' > '+value['name']+'/'+'elements'">Go To Message Details</a>
                </ng-container>
                <ng-container *ngIf="header==='applicability'">
                    <ng-container *ngIf="value[header].name!=='Base'">
                        <div appHighlightFilteredText [searchTerms]="filter" [text]="value[header].name" classToApply="ple-message-interface-table-highlighted-text" [attr.data-cy]="'submessage-table-'+header+'-'+value.name+'-'+value[header]">
                            {{value[header]}}
                        </div>
                    </ng-container>
                </ng-container>
            </ng-container>
            <ng-template #edit_Mode>
                <ng-container *ngIf="header!==' '">
                    <osee-messaging-edit-sub-message-field [messageId]="element.id" [subMessageId]="value['id']" [header]="header" [value]="value[header]" [attr.data-cy]="'submessage-table-'+header+'-'+value.name+'-'+value[header]"></osee-messaging-edit-sub-message-field>
                </ng-container>
                <ng-container *ngIf="header===' ' && (_messageRoute|async) as mRoute">
                    <a mat-raised-button [routerLink]="mRoute.beginning+element.id+'/'+value['id']+'/'+element.name+' > '+value['name']+'/'+'elements'+mRoute.end">Go To Message Details</a>
                </ng-container>
            </ng-template>
         </td>
        </ng-container>
        <ng-container matColumnDef="footer">
            <td mat-footer-cell *matFooterCellDef [attr.colspan]="(headers|async)?.length||0" style="text-align:right"></td>
        </ng-container>
     <tr mat-header-row *matHeaderRowDef="(headers|async)||[];"></tr>    
     <tr mat-row *matRowDef= "let row2; columns: (headers|async)||[]; let k=index;" [id]="'a'+row2.id"
     [ngClass]="k%2===0? row2.added? 'message-table-sub-message-row-even-added': row2.deleted?'message-table-row-even-deleted':row2.autogenerated?'message-table-row-autogenerated-even':'message-table-sub-message-row-even':row2.added?'message-table-sub-message-row-odd-added':row2.deleted?'message-table-row-odd-deleted':row2.autogenerated?'message-table-row-autogenerated-odd':'message-table-sub-message-row-odd'"
     [attr.data-cy]="'sub-message-table-row-'+row2.name"></tr>
     <tr mat-footer-row *matFooterRowDef="['footer']"></tr>
    </table>
</div>
<mat-menu #contextMenu="matMenu">
    <ng-template matMenuContent let-message="message" let-submessage="submessage" let-location="location" let-field="field" let-header="header" let-change="change">
        <ng-container *ngIf="(_messageRoute|async) as mRoute">
            <a mat-menu-item [routerLink]="mRoute.beginning+message.id+'/'+submessage.id+'/'+location+'/'+'elements'+mRoute.end"  data-cy="sub-msg-details-nav-btn"><mat-icon>subdirectory_arrow_right</mat-icon>Open submessage details</a>
            <a mat-menu-item target="_blank" [routerLink]="mRoute.beginning+message.id+'/'+submessage.id+'/'+location+'/'+'elements'+mRoute.end" data-cy="sub-msg-details-nav-new-tab-btn"><mat-icon color="primary">open_in_new</mat-icon>Open submessage details in new tab</a>
        </ng-container>
        <ng-container *ngIf="!submessage.autogenerated">
            <button mat-menu-item (click)="openDescriptionDialog(submessage.description,submessage.id,message.id)"  data-cy="sub-msg-open-description-btn"><mat-icon color="primary">description</mat-icon>Open Description</button>
        </ng-container>
        <ng-container *ngIf="isDifference(change)">
            <button mat-menu-item (click)="viewDiff(true,change,header)"><mat-icon color="accent"  data-cy="sub-msg-diff-btn">pageview</mat-icon>View Diff</button>
        </ng-container>
        <ng-container *ngIf="editMode==true;">
            <ng-container *ngIf="!submessage.autogenerated">
                <button mat-menu-item (click)="removeSubMessage(submessage,message)"><mat-icon color="warn"  data-cy="sub-msg-remove-btn">remove_circle_outline</mat-icon>Remove submsg from message</button>
                <button mat-menu-item (click)="deleteSubMessage(submessage)"><mat-icon color="warn"  data-cy="sub-msg-delete-btn">delete_forever</mat-icon>Delete submsg globally</button>
                <button mat-menu-item (click)="insertSubMessage(message,submessage.id)"  data-cy="sub-msg-insert-after-btn"><mat-icon color="success">add</mat-icon>Insert submsg after</button>
                <button mat-menu-item (click)="insertSubMessage(message,'start')"  data-cy="sub-msg-insert-top-btn"><mat-icon color="success">add</mat-icon>Insert submsg at top</button>
                <button mat-menu-item (click)="insertSubMessage(message)"  data-cy="sub-msg-insert-end-btn"><mat-icon color="success">add</mat-icon>Insert submsg at end</button>
            </ng-container>
            <ng-container *ngIf="submessage.autogenerated">
                <mat-label>
                    No options available for autogenerated submessages.
                </mat-label>
            </ng-container>
        </ng-container>
    </ng-template>
</mat-menu>
<div style="visibility: hidden; position: fixed;" 
[style.left]="menuPosition.x" 
[style.top]="menuPosition.y" 
[matMenuTriggerFor]="contextMenu"></div>