<!--
 * Copyright (c) 2021 Boeing
 *
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 *     Boeing - initial API and implementation
 -->
<div class="message-interface-table-view mat-elevation-z9">
    <table mat-table [dataSource]="dataSource" class="message-interface-table-view-width-100">
        <ng-container [matColumnDef]="header" *ngFor="let header of (headers|async)||[];let j=index;trackBy:valueTracker">
         <th mat-header-cell *matHeaderCellDef class="message-interface-table-view-sub-message-header" [matTooltip]="(getHeaderByName(header)|async)?.description||''">{{(getHeaderByName(header)|async)?.humanReadable||''}}</th>
         <td mat-cell *matCellDef="let value" class="message-interface-table-center" (contextmenu)="openMenu($event,element,value,element.name+' > '+value.name,value[header],header)" [ngClass]="!value.added && !value.deleted && value.changes && value.changes[header] !==undefined?'message-table-attribute-changed':'message-table-attribute-not-changed'">
            <ng-container *ngIf="editMode==false ||value.deleted; else edit_Mode;">
                <ng-container *ngIf="header==='description'">
                    <div appHighlightFilteredText [searchTerms]="filter" [text]="value[header] | displayTruncatedStringWithFieldOverflow:75" classToApply="ple-message-interface-table-highlighted-text">
                        {{value[header] | displayTruncatedStringWithFieldOverflow:75}}
                    </div>
                </ng-container>
                <ng-container *ngIf="header!=='description' && header!==' ' && header!=='applicability'">
                    <div appHighlightFilteredText [searchTerms]="filter" [text]="value[header]" classToApply="ple-message-interface-table-highlighted-text">
                        {{value[header]}}
                    </div>
                </ng-container>
                <ng-container *ngIf="header===' '"><a mat-raised-button [routerLink]="element.id+'/'+value['id']+'/'+element.name+' > '+value['name']+'/'+'elements'">Go To Message Details</a>
                </ng-container>
                <ng-container *ngIf="header==='applicability'">
                    <ng-container *ngIf="value[header].name!=='Base'">
                        <div appHighlightFilteredText [searchTerms]="filter" [text]="value[header].name" classToApply="ple-message-interface-table-highlighted-text">
                            {{value[header]}}
                        </div>
                    </ng-container>
                </ng-container>
            </ng-container>
            <ng-template #edit_Mode>
                <ng-container *ngIf="header!==' '">
                    <osee-messaging-edit-sub-message-field [messageId]="element.id" [subMessageId]="value['id']" [header]="header" [value]="value[header]"></osee-messaging-edit-sub-message-field>
                </ng-container>
                <ng-container *ngIf="header===' ' && (_messageRoute|async) as mRoute">
                    <a mat-raised-button [routerLink]="mRoute.beginning+element.id+'/'+value['id']+'/'+element.name+' > '+value['name']+'/'+'elements'+mRoute.end">Go To Message Details</a>
                </ng-container>
            </ng-template>
         </td>
        </ng-container>
        <ng-container matColumnDef="footer">
            <td mat-footer-cell *matFooterCellDef [attr.colspan]="(headers|async)?.length||0" style="text-align:right">
                <ng-container *ngIf="editMode===true;">
                    <button mat-mini-fab color="primary" (click)="createNewSubMessage()">+</button>
                </ng-container>
             </td>
        </ng-container>
     <tr mat-header-row *matHeaderRowDef="(headers|async)||[];"></tr>    
     <tr mat-row *matRowDef= "let row2; columns: (headers|async)||[]; let k=index;"
     [ngClass]="k%2===0? row2.added? 'message-table-sub-message-row-even-added': row2.deleted?'message-table-row-even-deleted':'message-table-sub-message-row-even':row2.added?'message-table-sub-message-row-odd-added':row2.deleted?'message-table-row-odd-deleted':'message-table-sub-message-row-odd'"
     ></tr>
     <tr mat-footer-row *matFooterRowDef="['footer']"></tr>
    </table>
</div>
<mat-menu #contextMenu="matMenu">
    <ng-template matMenuContent let-message="message" let-submessage="submessage" let-location="location" let-field="field" let-header="header">
        <ng-container *ngIf="(_messageRoute|async) as mRoute">
            <a mat-menu-item [routerLink]="mRoute.beginning+message.id+'/'+submessage.id+'/'+location+'/'+'elements'+mRoute.end"> Open submessage details</a>
            <a mat-menu-item target="_blank" [routerLink]="mRoute.beginning+message.id+'/'+submessage.id+'/'+location+'/'+'elements'+mRoute.end"> Open submessage details in new tab</a>
        </ng-container>
        <button mat-menu-item (click)="openDescriptionDialog(submessage.description,submessage.id,message.id)">Open Description</button>
        <ng-container *ngIf="submessage.changes[header]!==undefined">
            <button mat-menu-item (click)="viewDiff(true,submessage.changes[header],header)">View Diff</button>
        </ng-container>
        <ng-container *ngIf="editMode==true;">
            <button mat-menu-item (click)="removeSubMessage(submessage,message)">Remove submessage from message</button>
            <button mat-menu-item (click)="deleteSubMessage(submessage)">Delete submessage globally</button>
        </ng-container>
    </ng-template>
</mat-menu>
<div style="visibility: hidden; position: fixed;" 
[style.left]="menuPosition.x" 
[style.top]="menuPosition.y" 
[matMenuTriggerFor]="contextMenu"></div>