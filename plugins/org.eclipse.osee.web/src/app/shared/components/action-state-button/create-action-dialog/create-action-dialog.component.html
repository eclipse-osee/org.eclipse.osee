<!--
 * Copyright (c) 2022 Boeing
 *
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 *     Boeing - initial API and implementation
 -->
<h1 mat-dialog-title>Create Action</h1>
<div mat-dialog-content>
	<mat-form-field class="tw-w-full">
		<mat-label>Title</mat-label>
		<input
			matInput
			type="text"
			[(ngModel)]="data.title"
			#input
			required
			data-cy="action-title" />
	</mat-form-field>
	@if (workTypes | async; as _workTypes) {
		@if (data.defaultWorkType == '') {
			<mat-form-field class="tw-w-full">
				<mat-label>Work Type</mat-label>
				<mat-select
					[(ngModel)]="workType"
					(selectionChange)="selectWorkType($event)"
					required
					data-cy="select-work-type">
					<mat-option
						*ngFor="let item of _workTypes"
						[value]="item"
						[attr.data-cy]="'option-' + item.name">
						{{ item.humanReadableName }}
					</mat-option>
				</mat-select>
			</mat-form-field>
		}
	}
	@if (workType.name != '') {
		<mat-form-field class="tw-w-full">
			<mat-label>Actionable Item</mat-label>
			<mat-select
				[(ngModel)]="data.actionableItem"
				(selectionChange)="selectActionableItem()"
				required
				data-cy="select-actionable-item">
				<mat-option
					*ngFor="let item of actionableItems | async"
					[value]="item"
					[attr.data-cy]="'option-' + item.name">
					{{ item.name }}
				</mat-option>
			</mat-select>
		</mat-form-field>
	}
	<mat-form-field class="tw-w-full">
		<mat-label>Description</mat-label>
		<input
			matInput
			type="text"
			[(ngModel)]="data.description"
			#input
			required
			data-cy="action-description" />
	</mat-form-field>
	<mat-form-field class="tw-w-full">
		<mat-label>Priority</mat-label>
		<mat-select
			[(ngModel)]="data.priority"
			required
			data-cy="select-priority">
			<mat-option
				*ngFor="let item of priorities"
				[value]="item.value"
				[attr.data-cy]="'option-' + item.name">
				{{ item.name }}
			</mat-option>
		</mat-select>
	</mat-form-field>
	@if (data.actionableItem.id.length !== 0) {
		<mat-form-field class="tw-w-full">
			<mat-label>Change Type</mat-label>
			<mat-select
				[(ngModel)]="data.changeType"
				required
				data-cy="select-change-type">
				<mat-option
					*ngFor="let item of changeTypes | async"
					[value]="item"
					[attr.data-cy]="'option-' + item.name">
					{{ item.name }}
				</mat-option>
			</mat-select>
		</mat-form-field>
		@for (field of additionalFields | async; track $index) {
			@if (field.name === 'Targeted Version') {
				<mat-form-field class="tw-w-full">
					<mat-label>Targeted Version</mat-label>
					<mat-select
						[(ngModel)]="data.targetedVersion"
						data-cy="select-targeted-version">
						<mat-option
							*ngFor="let item of targetedVersions | async"
							[value]="item"
							[attr.data-cy]="'option-' + item.name">
							{{ item.name }}
						</mat-option>
					</mat-select>
				</mat-form-field>
			} @else if (field.name === 'Originator') {
				<mat-form-field class="tw-w-full">
					<mat-label>{{ field.name }}</mat-label>
					<mat-select
						[(ngModel)]="data.originator"
						[compareWith]="compareUsers"
						data-cy="select-originator">
						<mat-option
							*ngFor="let item of users | async"
							[value]="item"
							[attr.data-cy]="'option-' + item.name">
							{{ item.name }}
						</mat-option>
					</mat-select>
				</mat-form-field>
			} @else if (field.name === 'Assignees') {
				<mat-form-field class="tw-w-full">
					<mat-label>{{ field.name }}</mat-label>
					<mat-select
						[(ngModel)]="selectedAssignees"
						(selectionChange)="selectAssignees($event)"
						multiple
						data-cy="select-assignees">
						<mat-option
							*ngFor="let item of users | async"
							[value]="item"
							[attr.data-cy]="'option-' + item.name">
							{{ item.name }}
						</mat-option>
					</mat-select>
				</mat-form-field>
			} @else if (field.name === 'Points') {
				<mat-form-field class="tw-w-full">
					<mat-label>{{ field.name }}</mat-label>
					<mat-select
						[(ngModel)]="data.points"
						data-cy="select-points">
						<mat-option
							*ngFor="let item of points | async"
							[value]="item"
							[attr.data-cy]="'option-' + item">
							{{ item }}
						</mat-option>
					</mat-select>
				</mat-form-field>
			} @else if (field.name === 'Unplanned Work') {
				<mat-checkbox
					class="tw-pb-2"
					[(ngModel)]="data.unplanned"
					color="primary">
					<mat-label>Unplanned Work</mat-label>
				</mat-checkbox>
			} @else if (field.name === 'Work Package') {
				<mat-form-field class="tw-w-full">
					<mat-label>{{ field.name }}</mat-label>
					<input
						matInput
						[(ngModel)]="data.workPackage" />
				</mat-form-field>
			} @else if (field.name === 'Feature Group') {
				@if (featureGroups | async; as _featureGroups) {
					<mat-form-field class="tw-w-full">
						<mat-label>{{
							_featureGroups.length === 0
								? 'No Feature Groups Available'
								: field.name
						}}</mat-label>
						<mat-select
							[(ngModel)]="data.featureGroup"
							[disabled]="_featureGroups.length === 0"
							data-cy="select-feature-group">
							<mat-option
								*ngFor="let item of _featureGroups"
								[value]="item.id"
								[attr.data-cy]="'option-' + item.name">
								{{ item.name }}
							</mat-option>
						</mat-select>
					</mat-form-field>
				}
			} @else if (field.name === 'Sprint') {
				@if (sprints | async; as _sprints) {
					<mat-form-field class="tw-w-full">
						<mat-label>{{
							_sprints.length === 0
								? 'No Sprints available for this team'
								: field.name
						}}</mat-label>
						<mat-select
							[(ngModel)]="data.sprint"
							[disabled]="_sprints.length === 0"
							data-cy="select-sprint">
							<mat-option
								*ngFor="let item of _sprints"
								[value]="item.id"
								[attr.data-cy]="'option-' + item.name">
								{{ item.name }}
							</mat-option>
						</mat-select>
					</mat-form-field>
				}
			} @else if (field.widgetType === 'TEXT') {
				<mat-form-field class="tw-w-full">
					<mat-label>{{ field.name }}</mat-label>
					<input
						matInput
						[(ngModel)]="data.attrValues[field.attribute]" />
				</mat-form-field>
			} @else if (field.widgetType === 'BOOLEAN') {
				<mat-checkbox
					class="tw-pb-2"
					[(ngModel)]="data.attrValues[field.attribute]"
					color="primary">
					<mat-label>{{ field.name }}</mat-label>
				</mat-checkbox>
			}
		}
	}
	<mat-checkbox
		class="tw-pb-2"
		[(ngModel)]="data.createBranchDefault"
		color="primary">
		<mat-label>Create working branch</mat-label>
	</mat-checkbox>
</div>
<div mat-dialog-actions>
	<button
		mat-button
		(click)="onNoClick()">
		Cancel
	</button>
	<button
		mat-raised-button
		[mat-dialog-close]="data"
		color="primary"
		[disabled]="
			data.description.length === 0 ||
			data.title.length === 0 ||
			data.actionableItem.id.length === 0 ||
			data.originator.id.length === 0 ||
			data.changeType.id.length === 0
		"
		data-cy="submit-btn">
		Create Action
	</button>
</div>
