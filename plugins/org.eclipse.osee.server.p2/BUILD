

genrule(
  name = "osee_server_zip",
  srcs = ["//org.eclipse.osee.server.p2:server_plugins","//org.eclipse.osee.server.p2:server_files","//org.eclipse.osee.server.p2:json","//org.eclipse.osee.server.p2:create_config"],
  tools = ["@bazel_tools//tools/zip:zipper"],
  outs = ["org.eclipse.osee.server.p2.zip"],
  cmd = "cp -r $(locations server_plugins) plugins;rm -rf etc;mkdir etc;cp -r $(locations //org.eclipse.osee.server.p2:json) etc;rm -rf configuration; mkdir configuration;cp -r $(locations //org.eclipse.osee.server.p2:create_config) configuration;chmod -R 777 configuration;mkdir osee_server;cp -r $(locations //org.eclipse.osee.server.p2:server_files) osee_server;mv plugins osee_server;mv configuration osee_server;mv etc osee_server;echo zip2 plugins;$(location @bazel_tools//tools/zip:zipper) c thezip.zip  osee_server/* osee_server/plugins/* osee_server/etc/* osee_server/configuration/*;cp -r thezip.zip $@",
)

filegroup(
   name = "osee_server_plugins",
   srcs = [ "//org.eclipse.osee.accessor:osgi_jar",
	    "//org.eclipse.osee.account.admin:osgi_jar",
            "//org.eclipse.osee.account.rest:osgi_jar",
            "//org.eclipse.osee.account.rest.client:osgi_jar",
            "//org.eclipse.osee.account.rest.model:osgi_jar",
	    "//org.eclipse.osee.activity:osgi_jar",
	    "//org.eclipse.osee.activity.api:osgi_jar",
            "//org.eclipse.osee.app:osgi_jar",
            "//org.eclipse.osee.ats.api:osgi_jar",
            "//org.eclipse.osee.ats.core:osgi_jar",
            "//org.eclipse.osee.ats.rest:osgi_jar",
            "//org.eclipse.osee.authentication.admin:osgi_jar",
            "//org.eclipse.osee.authentication.ldap:osgi_jar",
            "//org.eclipse.osee.authorization.admin:osgi_jar",
            "//org.eclipse.osee.cache.admin:osgi_jar",
            "//org.eclipse.osee.config.admin:osgi_jar",
            "//org.eclipse.osee.console.admin:osgi_jar",
            "//org.eclipse.osee.define:osgi_jar",
	    "//org.eclipse.osee.define.operations.api:osgi_jar",
            "//org.eclipse.osee.define.rest.api:osgi_jar",
            "//org.eclipse.osee.disposition.rest:osgi_jar",
            "//org.eclipse.osee.disposition.rest.model:osgi_jar",
	    "//org.eclipse.osee.framework.core.model:osgi_jar",
            "//org.eclipse.osee.framework.core.server:osgi_jar",
	    "//org.eclipse.osee.framework.jdk.core:osgi_jar",
            "//org.eclipse.osee.framework.core:osgi_jar",
            "//org.eclipse.osee.framework.logging:osgi_jar",
	    "//org.eclipse.osee.logger.slf4j:osgi_jar",
            "//org.eclipse.osee.logger:osgi_jar",
            "//org.eclipse.osee.framework.resource.management:osgi_jar",
            "//org.eclipse.osee.framework.server.ide:osgi_jar",
            "//org.eclipse.osee.framework.server.ide.api:osgi_jar",
            "//org.eclipse.osee.jaxrs:osgi_jar",
            "//org.eclipse.osee.jaxrs.server:osgi_jar",
            "//org.eclipse.osee.jdbc:osgi_jar",
            "//org.eclipse.osee.mim:osgi_jar",
	    "//org.eclipse.osee.orcs.account.admin:osgi_jar",
	    "//org.eclipse.osee.orcs.authorization:osgi_jar",
	    "//org.eclipse.osee.orcs.core:osgi_jar",
	    "//org.eclipse.osee.orcs.db:osgi_jar",
	    "//org.eclipse.osee.orcs.rest.model:osgi_jar",
	    "//org.eclipse.osee.orcs.rest:osgi_jar",
	    "//org.eclipse.osee.orcs:osgi_jar",
	    "//org.eclipse.osee.testscript:osgi_jar",
            "//org.eclipse.osee.template.engine:osgi_jar",
            "//org.eclipse.osee.vcast:osgi_jar"
           ],
visibility = ["//visibility:public"]   
)

genrule(
  name = "build_no",
  srcs = ["osee_server_plugins",],
  outs = ["serv_plus"],
  cmd = "export version=1.0.0.v$$(date  +%Y%m%d%H%M);echo version: $$version;mkdir osee_plugins;for FILE in $(SRCS); do chmod 777 *; cp $$FILE  $${FILE%.*}_$$version.jar;mv $${FILE%.*}_$$version.jar osee_plugins;pwd;done;echo after move;chmod -R 777 osee_plugins; cp -r osee_plugins $@"
)

#"The rule of thumb when dealing with backslashes is keep adding up backslashes until you get the expected result." -wiktor-stribiÅ¼ew
genrule(
  name = "create_config",
  srcs = ["server_plugins"],
  outs = ["config.ini"],
  cmd = "echo -e 'osgi.bundles= \\\n\\' >> config.txt;ls -1 $(locations server_plugins) > server_plugins.txt;sed -i ' s/.jar/@start, \\\\\\/g' server_plugins.txt;sed -i '$$  s/, \\\\\\//g' server_plugins.txt;cat server_plugins.txt >> config.txt;echo -e 'osgi.noShutdown=true\neclipse.ignoreApp=true\nequinox.ds.debug=true\nosee.log.default=INFO\n' >> config.txt;cat server_plugins.txt;cp config.txt $@;"
)

genrule(
  name = "server_plugins",
  srcs = ["build_no","third_party_deps"],
  outs = ["plugins"],
  cmd = "mkdir s1p;cp -r $(locations build_no)/* s1p; cp -r $(locations //org.eclipse.osee.server.p2:third_party_deps) s1p;chmod -R 777 s1p; cp -r s1p $@;"
)

filegroup(
   name = "server_files",
   srcs = [ "runDemo.sh",
            "runPostgreSqlLocal.sh",
            "runHsql.sh",
            "runServer.sh",
            "runDemo.bat",
          ],
)

filegroup(
   name = "json",
   srcs = [ "etc/osee.postgresql.json",
            "etc/osee.hsql.json",
          ],
)

filegroup(
   name = "configuration",
   srcs = ["configuration/config.ini"],
)

filegroup(
    name = "third_party_deps",
    srcs = [
	    "@maven//:commons_codec_commons_codec",
	    "@maven//:com_fasterxml_jackson_core_jackson_annotations",
            "@maven//:com_fasterxml_jackson_core_jackson_core",
            "@maven//:com_fasterxml_jackson_core_jackson_databind",
	    "@maven//:com_fasterxml_jackson_jaxrs_jackson_jaxrs_base",
	    "@maven//:com_fasterxml_jackson_jaxrs_jackson_jaxrs_json_provider",
	    "@maven//:com_fasterxml_jackson_dataformat_jackson_dataformat_yaml",
	    "@maven//:com_fasterxml_jackson_datatype_jackson_datatype_jsr310",
            "@maven//:com_vladsch_flexmark_flexmark_ext_gfm_tasklist",
	    "@maven//:com_vladsch_flexmark_flexmark_ext_tables",
	    "@maven//:com_vladsch_flexmark_flexmark_util_ast",
	    "@maven//:com_vladsch_flexmark_flexmark_util_data",
	    "@maven//:com_vladsch_flexmark_flexmark",
            "@maven//:jakarta_xml_bind_jakarta_xml_bind_api",
	    "@maven//:jakarta_activation_jakarta_activation_api",
            "@maven//:javax_activation_activation",
            "@maven//:javax_mail_mail",
            "@maven//:javax_servlet_javax_servlet_api",
	    "@maven//:com_googlecode_javaewah_JavaEWAH",
            "@maven//:org_antlr_antlr_runtime",
	    "@maven//:org_apache_felix_org_apache_felix_gogo_runtime",
	    "@maven//:org_apache_felix_org_apache_felix_gogo_command",
	    "@maven//:org_apache_felix_org_apache_felix_gogo_shell",
	    "@maven//:org_apache_felix_org_apache_felix_scr",
	    "@maven//:org_apache_cxf_cxf_core",
	    "@maven//:org_apache_cxf_cxf_rt_frontend_jaxrs",
	    "@maven//:org_apache_cxf_cxf_rt_rs_client",
	    "@maven//:org_apache_cxf_cxf_rt_rs_security_oauth2",
	    "@maven//:org_apache_cxf_cxf_rt_security",
	    "@maven//:org_apache_cxf_cxf_rt_transports_http",
	    "@maven//:org_apache_cxf_cxf_rt_rs_service_description",
	    "@maven//:org_apache_cxf_cxf_rt_rs_json_basic",
	    "@maven//:org_apache_cxf_cxf_rt_rs_security_jose",
	    "@maven//:org_apache_cxf_cxf_rt_rs_security_jose_jaxrs",
            "@maven//:org_eclipse_jgit_org_eclipse_jgit",
            "@maven//:org_eclipse_jdt_org_eclipse_jdt_annotation",
            "@maven//:org_eclipse_jdt_org_eclipse_jdt_core",
	    "@maven//:org_hsqldb_hsqldb",
	    "@maven//:org_yaml_snakeyaml",
	    "@maven//:io_github_classgraph_classgraph",
	    "@maven//:org_apache_commons_commons_lang3",
	    "@maven//:org_apache_commons_commons_math3",
	    "@maven//:org_jsoup_jsoup",
	 #   "@maven//:org_slf4j_slf4j_api",
	    "@maven//:org_apache_ws_xmlschema_xmlschema_core",
	    "@maven//:org_apache_commons_commons_collections4",
	    "@maven//:org_eclipse_jetty_jetty_http",
	    "@maven//:org_eclipse_jetty_jetty_server",
	    "@maven//:org_eclipse_jetty_jetty_io",
	    "@maven//:org_eclipse_jetty_jetty_security",
	    "@maven//:org_eclipse_jetty_jetty_util",
	    "@maven//:org_eclipse_jetty_jetty_util_ajax",
            "@maven//:org_eclipse_jetty_jetty_servlet",
	    "@maven//:net_oauth_core_oauth",
	    "@ext_jars//:emf",
	    "@ext_jars//:apache_commons_lang",
            "@ext_jars//:nebula",
	    "@ext_jars//:rmf",
	    "@ext_jars//:jgit",
	    "@ext_jars//:swt",
	    "@eclipse_core_net//jar",
            "@eclipse_osgi_services//jar",
	    "@eclipse_osgi//jar",
	    "@eclipse_osgi_util//jar",
	    "@eclipse_equinox_console//jar",
	    "@eclipse_equinox_app//jar",
	    "@eclipse_equinox_preferences//jar",
	    "@eclipse_equinox_registry//jar",
	    "@eclipse_equinox_common//jar",
	    "@eclipse_equinox_launcher//jar",
	    "@eclipse_equinox_metatype//jar",
	    "@eclipse_equinox_event//jar",
	    "@eclipse_equinox_cm//jar",
	    "@eclipse_equinox_ds//jar",
            "@eclipse_debug_core//jar",
	    "@eclipse_core_filebuffers//jar",
	    "@eclipse_core_filesystem//jar",
	    "@eclipse_core_commands//jar",
	    "@eclipse_core_resources//jar",
	    "@eclipse_core_jobs//jar",
	    "@eclipse_core_runtime//jar",
	    "@eclipse_core_expressions//jar",
	    "@eclipse_core_contenttype//jar",
	    "@eclipse_core_variables//jar",
	    "@eclipse_equinox_http_jetty//jar",	    
	    "@eclipse_equinox_http_servlet//jar",
	    "@eclipse_text//jar",
	    "@javax_mail//jar",
	    "@javax_validation//jar",
	    "@javax_servlet//jar",
            "@javax_xml_soap//jar",
	    "@javax_xml_ws//jar",
	    "@javax_xml_bind//jar",
	    "@javax_xml//jar",
	    "@javax_ws_rs//jar",
	    "@javax_transaction//jar",
	    "@javax_activation//jar",
	    "@javax_annotation//jar",
	    "@equinox_security//jar",
	    "@jcraft//jar",
	    "@apache_commons_codec//jar",
	    "@apache_xerces//jar",	 
	    "@apache_xml_resolver//jar",
	    "@google_guava//jar",
	    "@antlr_runtime//jar",
	    "@slf4j_api//jar",
	    "@swagger_core//jar",
	    "@swagger_annotations//jar",
	    "@swagger_integration//jar",
	    "@swagger_jaxrs2//jar",
	    "@swagger_models//jar",
	    "@apache_poi//jar",
	    "@apache_poi_ooxml//jar",
	    "@apache_poi_ooxml.schemas//jar",
         ],
)

filegroup(
   name = "equinox_jar",
   srcs = ["plugins/org.eclipse.equinox.launcher_1.5.700.v20200207-2156.jar"]
)

genrule(
   name = "runDemo",
   srcs = ["equinox_jar"],
   outs = ["out.txt"],
   cmd = "java -server \
-Xmx3G \
-Dorg.osgi.service.http.port=8089 \
-Dlogback.configurationFile=logback-dev.xml \
-Dorg.eclipse.equinox.http.jetty.context.sessioninactiveinterval=3600 \
-Dcm.config.uri=etc/osee.hsql.json \
-Dosee.authentication.protocol=demo \
-Dosee.application.server.data=demo/binary_data \
-jar $(location :equinox_jar) -console -consoleLog; pwd; ls > $@",
)

