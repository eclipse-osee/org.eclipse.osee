<project name="Contribute Extra Build Steps" default="noDefault">

	<!-- Dummy Default -->
	<target name="noDefault">
		<echo message="You must specify a target when invoking this file" />
	</target>

	<!-- ////////////////////////////////////////////////////////////////////// -->
	<!-- OSEE BASE EXTRA 											            -->
	<!-- ////////////////////////////////////////////////////////////////////// -->
	<target name="getDependencies" />

	<target name="preFetch">
		<antcall target="getAdditionalMaps" />
		<if>
			<equals arg1="${fetchTag}" arg2="HEAD" />
			<then>
				<echo message="Building from HEAD" />
			</then>
			<else>
				<echo message="Building from ${fetchTag}" />
				<antcall target="updateMapFiles" />
			</else>
		</if>
	</target>

	<target name="getAdditionalMaps" if="mapLocation">
		<for param="additionalMapFile" delimiter="," list="${mapLocation}">
			<sequential>
				<propertyregex property="resourceName" override="true" input="@{additionalMapFile}" regexp="[^/}]+$" select="\0" casesensitive="false" />
				<get dest="${buildDirectory}/maps/${resourceName}" src="@{additionalMapFile}" />
				<concat destfile="${buildDirectory}/directory.txt" append="true" fixlastline="yes">
					<fileset file="${buildDirectory}/maps/${resourceName}" />
				</concat>
			</sequential>
		</for>
	</target>

	<target name="updateMapFiles">
		<pathconvert property="map.files" setonempty="false" pathsep=";">
			<path>
				<fileset dir="${buildDirectory}/maps">
					<include name="*.map" />
				</fileset>
			</path>
		</pathconvert>

		<for param="map.file" delimiter=";" list="${map.files}">
			<sequential>
				<!--<propertyregex property="resourceName" override="true" input="@{map.file}" regexp="[^/}]+$" select="\0" casesensitive="false" />-->
				<updateMapFile srcfile="@{map.file}" destfile="@{map.file}" tag="${fetchTag}" />
			</sequential>
		</for>
		<updateMapFile srcfile="${buildDirectory}/directory.txt" destfile="${buildDirectory}/directory.txt" tag="${fetchTag}" />
		<updateMapFile srcfile="${buildDirectory}/../directory.txt" destfile="${buildDirectory}/../directory.txt" tag="${fetchTag}" />
	</target>

	<macrodef name="updateMapFile">
		<attribute name="destfile" />
		<attribute name="srcfile" />
		<attribute name="tag" />
		<sequential>
			<var name="data" unset="true" />
			<loadfile property="data" srcfile="@{srcfile}" />
			<propertyregex property="new.content" input="${data}" defaultvalue="${data}" regexp="trunk" replace="@{tag}" casesensitive="false" override="true" />
			<echo append="false" file="@{destfile}" message="${new.content}" />
		</sequential>
	</macrodef>

	<target name="postFetch" />
	<target name="preGenerate" />
	<target name="postGenerate" />
	<target name="preAssemble" />
	<target name="postAssemble" />
	<target name="prePackage" />
	<target name="postPackage" />
	<target name="preProcess" />
	<target name="postProcess" />
	<target name="postBuild" />
	<target name="extraPackaging" />
</project>
